# DEVELOPMENT_RULES.md

## 1. 처리 원칙
1) **병렬 처리 금지**  
   - 모든 연산은 **순차적**으로 처리한다.  
   - 멀티스레딩/멀티프로세싱 불가.

2) **휴장일 처리**  
   - 휴장일에는 **데이터를 생성하지 않는다**.  
   - 휴장일에는 종목 가격을 새로 조회하지 않고, **마지막 거래일의 캐시**를 사용한다.  
   - 휴장일 이후에는 **다음 거래일 데이터 기준**으로 신호를 생성한다.

---

## 2. 종목가격 원칙
1) **저장 위치**  
   - `data/cache/{country}/*.pkl` 에 캐시 저장, 필요 시 **증분만** 조회한다.

2) **가격 소스/시점**  
   - 예: 9시 개장 가정. **개장 전**에는 전일 종가 사용, **개장 후~자정**은 당일 가격 사용.  
   - **휴장일**에는 직전 거래일 가격 사용.  
   - **KR(한국)**: 개장 후~자정에는 **네이버 금융 실시간 시세**를 사용(가능 시).

---

## 3. 평가금액 계산 원칙
1) **휴장일 평가금액**  
   - **마지막 거래일 평가금액과 동일**하게 본다.

2) **평가금액 자동 보정**  
   - 보유 종목 현재가 합이 기록된 평가금액보다 **크거나**,  
   - 평가금액이 **0**일 때,  
   → 평가금액을 **보유 종목 가치 합**으로 자동 보정한다.  
   - 사용자가 입력했거나 스케줄러가 입력한 **0이 아닌 평가금액은 결코 줄이지 않는다.**

---

## 4. 저장 및 기록 원칙
- 모든 주요 이벤트는 **파일 로그**에 기록.  
- 로그 레벨  
  - `INFO`: 정상 처리  
  - `WARNING`: 데이터 누락/불완전  
  - `ERROR`: 실행 실패

---

## 5. 예외 처리 원칙
1) **대상 제외 종목**  
   - `etf.json`에서 `is_active: false` 종목은 계산에서 제외.

2) **거래 데이터 부족**  
   - 필요한 기간 데이터가 부족한 종목은 제외하고 `WARNING` 로그 남김.  
   - 테스트/튜닝 시에는 **존재하는 구간만** 사용.

3) **거래 불가 종목**  
   - 거래 정지/상폐 등은 건너뛰고 `WARNING` 로그.

4) **비정상 데이터**  
   - 음수 가격, 필드 누락 등은 **즉시 중단**, `ERROR` 로그 + 알림(텔레그램/슬랙).

---

## 6. 코드 생성/관리 원칙
- 함수/클래스 단위 모듈화(**1파일 1기능** 권장).  
- 중복 발견 시 리팩터링 제안.  
- 사용하지 않는 import/함수 제거.  
- **Python 3.8 호환**: `X | Y` 사용 금지, `typing.Optional/Union/List/Dict` 사용.

---

## 7. 확장 원칙
- 새로운 전략/지표 추가 시 **본 문서 우선**.  
- 규칙과 충돌 시, **문서를 먼저 업데이트**한 뒤 반영.

---

## 8. 실행 환경
- **형수님 NAS(DS220j, DSM)**에서 동작 가능해야 함(venv + 스케줄러, Docker 미사용).

