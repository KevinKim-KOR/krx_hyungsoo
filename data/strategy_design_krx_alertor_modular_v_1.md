# 전략 설계 명세서 (v1)

> 목적: 사용자 PC(Windows, RTX 4070 SUPER)에서 “우리 로직”의 과거~현재 성과를 검증하고, 부족 시 설계를 개선하여 **실전 투자 계획**으로 승격.

---

## 1) 목표 & 제약
- **목표**: ETF 중심으로 성장 70% / 배당 30%의 **장기 누적수익 + 하방 방어**
- **벤치마크**: KOSPI200, KODEX200(069500), 또는 사용자 지정 혼합 벤치마크
- **제약**: 병렬 금지(순차), 휴장일 캐시 재사용, 레버리지/인버스 **기본 제외**
- **비용 가정**: 왕복 0.20% (수수료+슬리피지 합산, 수정 가능)

---

## 2) 유니버스 (KR ETF 중심, 확장 가능)
- **성장형 예시**: TIGER나스닥100, KODEX2차전지산업, KODEX반도체, KODEX미국S&P500TR, KODEX미국나스닥100TR 등
- **배당형 예시**: KODEX배당가치, ARIRANG고배당주, TIGER배당성장 등
- **제외 규칙**: `etf.json`에서 `is_active: false` 제외, 레버리지/인버스 제외(옵션 토글)

---

## 3) 데이터 & 사전 규칙
- **가격 소스/시점**: 개장 전 전일 종가, 개장~자정 당일가, 휴장일 직전거래일 캐시
- **거래일 정의**: 069500 일봉 존재일, 레짐 200SMA 사용
- **무결성**: 음수/결측/역정렬 시 즉시 실패, WARNING/ERROR 표준 준수

---

## 4) 시그널 설계 (v1 베이스라인)
### 4.1 모멘텀 점수(score_abs)
- 룩백: 1M/3M/6M 수익률을 표준화 후 가중 합(예: 1:2:3)
- 정규화: z-score 또는 rank-normalize
- 필터: 20거래일 이상 데이터 부족 종목 제외

### 4.2 순위 기반(rank)
- 룩백: 6M 총수익률 단일 기준으로 단순 랭크
- 동률: 최근 1M 수익률로 tie-breaker

### 4.3 변동성 캡
- 20일 표준편차(연율화) > 상위 15% 종목 **비중 반감** (리스크 조절)

### 4.4 배당/퀄리티 보정(옵션)
- 배당지표(과거 12M 분배금/가격), 퀄리티 대리(변동성 역수)로 **+α 보정** 가중치

---

## 5) 포트폴리오 구성 & 리밸런스
- **선정**: 모드별 상위 TOP 5 (성장 바스켓 3, 배당 바스켓 2 등 조합 가능)
- **비중**: 동일 가중(20%씩) 기본, 변동성 캡 반영 시 15~25% 범위 자동 조정
- **리밸런스**: 주 1회(금요일 종가), 드리프트 ±7.5% 초과 시 조정
- **현금 보유**: 레짐 필터 OFF 비율만큼 현금(또는 단기채 ETF) 대기

---

## 6) 리스크 관리
- **레짐 필터**: KODEX200 200SMA 하방 시 **순위 TOP5 중 절반 축소**(또는 50% 현금)
- **개별 스톱**: -15% 누적 손실 시 차기 리밸런스에서 교체(즉시 손절 아님)
- **익절/롤링**: +25% 도달 종목은 후속 2주 내 다른 후보가 상회 시 교체

---

## 7) 백테스트 프로토콜
- **구간**: 2018-01-01 ~ 현재
- **거래 비용**: 왕복 0.20% (변수화)
- **산출물**: CSV(체결/비중/수익률), JSON 요약(CAGR, VOL, MDD, Sharpe, Calmar, WinRate, Turnover)
- **통계**: 뉴먼-케울스 또는 부트스트랩으로 전략-벤치 차이 신뢰구간(옵션)

---

## 8) 검증 체크리스트
- 동일 입력 3회 실행 → **동일 결과 파일 해시** 일치
- 휴장일 데이터 생성 시도 없음(log 확인)
- 레짐 ON/OFF 결과 **두 세트** 저장 및 비교
- 거래 비용 0.10/0.20/0.30% 감도 분석

---

## 9) 워크플로우 (E2E)
1) 캐시 부트스트랩 → 2) 단일 시나리오 실행 → 3) 교차 시나리오(상승/하락×두 전략) → 4) 감도 분석(비용/룩백/TopN) → 5) 레짐 ON/OFF → 6) 보고서 요약 생성 → 7) 결론/다음 액션

---

## 10) 의사코드 (백테스트 핵심)
```python
for date in rebalance_dates:
    candidates = universe.active_on(date)
    scores = score_fn(candidates, lookbacks, cache)
    ranked = rank(scores)
    picks = topN(ranked, N=5)
    weights = equal_weight(picks)
    weights = volatility_cap(weights, sigma20, cap_pct=0.5)
    weights = apply_regime_filter(weights, regime=KODEX200_SMA200)
    portfolio.rebalance(picks, weights, fee=fee_roundtrip)
    portfolio.mark_to_market(next_rebalance)
```

---

## 11) 승인 기준(프로덕션 승격)
- CAGR ≥ 벤치마크 + 2%p  
- MDD ≤ 벤치마크 × 0.9  
- Calmar ≥ 0.6, Sharpe ≥ 0.8  
- Turnover ≤ 월 40%  
- 2018~현재 및 최근 12/24개월 **동시 통과**

---

## 12) 향후 개선 후보
- 팩터 믹스(모멘텀+퀄리티/배당), 적응형 룩백, 변동성 타깃팅(annualized vol 목표), 슬리피지 동적 추정, 월간/주간 하이브리드 리밸런스

---

## 13) 차별화 포인트(본 프로젝트)
- **한국 시장 특화**: 휴장일/장외 처리, KODEX200 레짐, KR ETF 실무 운용 규칙 반영
- **운영 일원화**: NAS 런북 + PC GPU 백테스트 + Telegram 알림 **엔드투엔드**
- **재현성 중시**: 캐시 스냅샷, 동일 입력 → 동일 출력 해시 검증
- **리스크 우선**: 변동성 캡·현금 대기·스톱/익절 롤링 규칙의 단순·명시화
```}

