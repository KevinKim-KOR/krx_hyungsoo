<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KRX Alertor - Auto Trading Observer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js" crossorigin></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"
        crossorigin></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.12.7/Recharts.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <style>
        body {
            background-color: #0f172a;
            color: #e2e8f0;
            font-family: 'Pretendard', sans-serif;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #0f172a;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }

        .animate-fade-in-up {
            animation: fadeInUp 0.5s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>
    <div id="root">
        <div style="padding: 20px; text-align: center; color: #94a3b8;">
            Loading Dashboard...
        </div>
    </div>

    <script type="text/babel">
        // Safety Check for Libraries
        if (!window.React || !window.ReactDOM || !window.Recharts) {
            document.getElementById('root').innerHTML = `
                <div style="padding: 40px; text-align: center; color: #ef4444; border: 1px dashed #ef4444; margin: 20px; border-radius: 8px;">
                    <h2 style="font-size: 20px; font-weight: bold; margin-bottom: 10px;">Library Loading Failed</h2>
                    <p>Required libraries (React or Recharts) failed to load from CDN.</p>
                    <p style="font-size: 12px; margin-top: 10px; color: #94a3b8;">Please check your internet connection or try refreshing.</p>
                    <p style="font-size: 10px; margin-top: 5px; color: #64748b;">Debug: React=${!!window.React}, Recharts=${!!window.Recharts}</p>
                </div>
            `;
            throw new Error("Library loading failed");
        }

        const { useState, useEffect, useMemo } = React;
        const { LineChart, Line, XAxis, YAxis, Tooltip, ResponsiveContainer, AreaChart, Area, BarChart, Bar, Cell } = window.Recharts;

        // API Configuration
        const API_BASE = "http://localhost:8000";

        // Utils
        const formatMoney = (val) => new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW' }).format(val);
        const formatAmount = (val) => new Intl.NumberFormat('ko-KR').format(val);

        // --- Components ---

        function Badge({ status }) {
            if (!status) return <span className="px-2 py-0.5 rounded text-xs font-bold bg-slate-700 text-slate-400">LOADING</span>;

            const badgeColor =
                status.badge === 'OK' ? 'bg-emerald-500/20 text-emerald-400 border border-emerald-500/30' :
                    status.badge === 'SKIP' ? 'bg-amber-500/20 text-amber-400 border border-amber-500/30' :
                        status.badge === 'FAIL' ? 'bg-red-500/20 text-red-400 border border-red-500/30' :
                            'bg-slate-500/20 text-slate-400 border border-slate-500/30';

            return (
                <div className={`px-3 py-1 rounded-full text-xs font-bold flex items-center gap-2 ${badgeColor}`}>
                    <div className={`w-2 h-2 rounded-full ${status.badge === 'OK' ? 'bg-emerald-400 animate-pulse' : 'bg-current'}`}></div>
                    {status.badge}
                    <span className="opacity-50">|</span>
                    <span className="font-mono">{status.asof}</span>
                </div>
            );
        }

        function StatCard({ label, value, subValue, trend }) {
            return (
                <div className="bg-slate-800 border border-slate-700 p-4 rounded-xl relative overflow-hidden group hover:border-cyan-500/30 transition-all">
                    <div className="text-slate-400 text-xs font-bold uppercase tracking-wider mb-2">{label}</div>
                    <div className="text-2xl font-bold text-white font-mono">{value}</div>
                    {subValue && (
                        <div className={`text-xs mt-1 font-mono flex items-center gap-1 ${trend === 'up' ? 'text-emerald-400' : trend === 'down' ? 'text-red-400' : 'text-slate-500'}`}>
                            {trend === 'up' && '‚ñ≤'} {trend === 'down' && '‚ñº'} {subValue}
                        </div>
                    )}
                </div>
            )
        }

        function KPICard({ label, value, sub, color }) {
            return (
                <div className="bg-slate-900/50 p-4 rounded-lg border border-slate-800">
                    <div className="text-[10px] text-slate-500 uppercase font-bold mb-1">{label}</div>
                    <div className={`text-xl font-mono font-bold ${color || "text-white"}`}>{value}</div>
                    {sub && <div className="text-[8px] text-slate-600 mt-1">{sub}</div>}
                </div>
            );
        }

        function SignalsList({ signals }) {
            if (!signals || signals.length === 0) {
                return (
                    <div className="p-8 text-center border border-dashed border-slate-700 rounded-lg">
                        <div className="text-4xl mb-4">üí§</div>
                        <h3 className="text-lg font-bold text-slate-400">No Action Today</h3>
                        <p className="text-sm text-slate-500 mt-2">Ïò§Îäò Ïã§ÌñâÎêú ÏßÑÏûÖ/Ï≤≠ÏÇ∞ ÏãúÍ∑∏ÎÑêÏù¥ ÏóÜÏäµÎãàÎã§.</p>
                    </div>
                );
            }

            return (
                <div className="grid gap-3">
                    {signals.map((sig, idx) => (
                        <div key={idx} className="bg-slate-800 border border-slate-700 p-4 rounded-lg flex items-center justify-between hover:border-cyan-500/50 transition-colors">
                            <div className="flex items-center gap-4">
                                <span className={`px-3 py-1 text-xs font-bold rounded ${sig.signal_type === 'BUY' ? 'bg-red-500/20 text-red-400 border border-red-500/30' :
                                    sig.signal_type === 'SELL' ? 'bg-blue-500/20 text-blue-400 border border-blue-500/30' : 'bg-slate-700'
                                    }`}>
                                    {sig.signal_type}
                                </span>
                                <span className="font-mono text-lg font-bold text-white tracking-widest">{sig.code}</span>
                            </div>
                            <div className="text-right">
                                <div className="text-sm text-slate-300">{sig.reason}</div>
                                {sig.score && <div className="text-xs text-slate-500 font-mono">Score: {sig.score.toFixed(2)}</div>}
                            </div>
                        </div>
                    ))}
                </div>
            );
        }

        function IntegrityBanner({ issues }) {
            if (!issues || issues.length === 0) return null;
            return (
                <div className="animate-fade-in-up mb-8 space-y-2">
                    {issues.map((issue, i) => (
                        <div key={i} className="bg-red-900/80 border border-red-500 text-red-100 px-6 py-4 rounded-lg flex items-start gap-4 shadow-lg shadow-red-900/20">
                            <div className="text-2xl pt-0.5">üö®</div>
                            <div>
                                <h3 className="font-bold text-lg flex items-center gap-2">
                                    [CRITICAL] {issue.id}
                                    <span className="text-xs bg-red-950 px-2 py-0.5 rounded text-red-300 font-mono">{issue.when}</span>
                                </h3>
                                <p className="text-red-200 mt-1">{issue.message}</p>
                            </div>
                        </div>
                    ))}
                </div>
            );
        }

        function ValidationView({ data }) {
            if (!data || data.status === 'not_ready') {
                return (
                    <div className="flex flex-col items-center justify-center py-20 border border-dashed border-slate-700 rounded-lg opacity-70">
                        <div className="text-4xl mb-4">üöß</div>
                        <h3 className="text-xl font-bold text-slate-400">Í≤ÄÏ¶ù Î¶¨Ìè¨Ìä∏ Ï§ÄÎπÑ Ï§ë</h3>
                        <p className="text-sm text-slate-500 mt-2">Tools > OOS Verification Ïã§Ìñâ ÌõÑ Îã§Ïãú ÌôïÏù∏ÌïòÏÑ∏Ïöî.</p>
                    </div>
                );
            }

            return (
                <div className="space-y-12">
                    {Object.entries(data.years).map(([year, info]) => {
                        const validSummary = info.summary;
                        return (
                            <section key={year} className="bg-slate-800 border border-slate-700 rounded-2xl p-6 md:p-8">
                                {/* Header */}
                                <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 border-b border-slate-700 pb-4 gap-4">
                                    <h2 className="text-2xl font-bold text-white tracking-widest">{year} <span className="text-sm font-normal text-slate-500 ml-2">Phase 9 Validation</span></h2>
                                    <div className="flex gap-6 text-right">
                                        <div>
                                            <div className="text-xs text-slate-400">Total Return</div>
                                            <div className="text-xl font-bold text-white mb-2">{formatAmount(validSummary.total_return_pct)}%</div>
                                            <div className={`text-xs ${validSummary.total_return_pct > 0 ? 'text-green-400' : 'text-red-400'}`}>
                                                {validSummary.total_return_pct > 0 ? '‚ñ≤' : '‚ñº'} Total Return
                                            </div>
                                        </div>
                                        <div>
                                            <div className="text-xs text-slate-400">MDD</div>
                                            <div className="text-lg font-mono font-bold text-slate-200">{info.summary.mdd_pct}%</div>
                                        </div>
                                        <div>
                                            <div className="text-xs text-slate-400">Trades</div>
                                            <div className="text-lg font-mono font-bold text-cyan-400">{info.summary.trades}</div>
                                        </div>
                                    </div>
                                </div>

                                {/* Heatmap Grid */}
                                <div className="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
                                    {info.monthly.map((m) => {
                                        const ret = m.return_pct;
                                        const isProfit = ret > 0;

                                        // Color Logic
                                        let bgClass = "bg-slate-700";
                                        if (ret <= -5) bgClass = "bg-red-900";
                                        else if (ret < 0) bgClass = "bg-red-900/40";
                                        else if (ret >= 5) bgClass = "bg-green-700";
                                        else if (ret > 0) bgClass = "bg-green-900/40";

                                        // Border for High Activity
                                        const borderClass = m.trades >= 40 ? "border-2 border-yellow-500/50" : "border border-slate-600";

                                        return (
                                            <div key={m.month} className={`${bgClass} ${borderClass} rounded-lg p-3 relative h-24 hover:scale-105 transition-transform`}>
                                                <div className="text-xs text-slate-400 mb-1">{m.month.split('-')[1]}Ïõî</div>
                                                <div className={`text-lg font-mono font-bold ${isProfit ? 'text-green-300' : 'text-red-300'}`}>
                                                    {ret > 0 ? '+' : ''}{ret}%
                                                </div>
                                                <div className="absolute bottom-2 right-2 text-xs font-mono text-slate-500">
                                                    {m.trades}t
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </section>
                        );
                    })}
                </div>
            );
        }

        function DiagnosisView({ humanReport, dailyRows }) {
            // Contract 5: DiagnosisView only renders Human Report + Daily Rows. No calculations.

            // 1. Loading State
            if (!humanReport || !dailyRows) {
                return (
                    <div className="flex flex-col items-center justify-center py-20 border border-dashed border-slate-700 rounded-lg opacity-70">
                        <div className="text-4xl mb-4">ü©∫</div>
                        <h3 className="text-xl font-bold text-slate-400">Loading Contract 5 Report...</h3>
                    </div>
                );
            }

            // 2. Critical/Error State Handling (Contract 5 Headline Badge)
            const badge = humanReport.headline?.status_badge ?? 'N/A';
            const isCritical = ["ERROR", "CRITICAL"].includes(badge);

            if (isCritical) {
                return (
                    <div className="flex flex-col items-center justify-center py-20 bg-red-900/10 border border-red-500 rounded-lg">
                        <div className="text-6xl mb-6">üö®</div>
                        <h2 className="text-3xl font-bold text-red-500 mb-2">SYSTEM ALERT: {badge}</h2>
                        <p className="text-xl text-red-200 mb-8">{humanReport.headline?.one_liner_ko ?? 'N/A'}</p>

                        <div className="bg-black/50 p-6 rounded-lg text-left font-mono text-sm text-slate-300 w-full max-w-2xl">
                            <h4 className="font-bold text-white mb-2 border-b border-slate-600 pb-1">Integrity Summary</h4>
                            <div className="grid grid-cols-2 gap-4">
                                <span>Critical Issues:</span> <span className="text-red-500 font-bold">{humanReport.integrity_summary?.critical_total ?? 0}</span>
                                <span>Warning Issues:</span> <span className="text-amber-500">{humanReport.integrity_summary?.warning_total ?? 0}</span>
                            </div>
                            <div className="mt-4 border-t border-slate-700 pt-2">
                                <h5 className="text-xs text-slate-500 mb-1">Top Issues</h5>
                                {humanReport.top_issues.map((issue, idx) => (
                                    <div key={idx} className="flex justify-between text-red-300">
                                        <span>{issue.code}</span>
                                        <span>{issue.count} days</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                );
            }

            // 3. Normal Dashboard (Ready / Warning)
            // Drill-down Support
            const [filteredCode, setFilteredCode] = useState(null);

            // Filter Logic based on Row Integrity (Recon Daily V1 schema)
            const filteredDaily = filteredCode
                ? dailyRows.filter(row => row.integrity && row.integrity.codes.includes(filteredCode))
                : dailyRows;

            // Sorting (Contract 5 default: date_asc)
            const sortedDaily = [...filteredDaily].sort((a, b) => a.trade_date.localeCompare(b.trade_date));

            const toggleFilter = (code) => {
                if (filteredCode === code) setFilteredCode(null);
                else setFilteredCode(code);
            };

            return (
                <div className="space-y-6">
                    {/* Header Block */}
                    <div className="flex justify-between items-start bg-slate-800 p-6 rounded-xl border border-slate-700">
                        <div>
                            <div className="flex items-center gap-3 mb-1">
                                <h2 className="text-2xl font-bold text-white">{humanReport.headline?.title_ko ?? 'N/A'}</h2>
                                <span className={`px-2 py-0.5 text-xs font-bold rounded ${badge === 'READY' ? 'bg-emerald-900 text-emerald-300' : 'bg-amber-900 text-amber-300'}`}>
                                    {badge}
                                </span>
                            </div>
                            <p className="text-slate-400">{humanReport.headline?.one_liner_ko ?? 'N/A'}</p>
                            <div className="text-xs text-slate-500 mt-2 font-mono">
                                AsOf: {humanReport.asof} | SoT Hash: {humanReport.determinism?.summary_hash?.substring(0, 8) || 'N/A'}...
                            </div>
                        </div>

                        <div className="text-right">
                            <div className="text-sm text-slate-400">Trade Counts (Policy V1)</div>
                            <div className="text-xl font-mono text-white">
                                L1: {humanReport.trade_counts?.L1_actions ?? 'N/A'} / L2: {humanReport.trade_counts?.L2_trades ?? 'N/A'}
                            </div>
                            <div className={`text-sm ${humanReport.trade_counts?.delta === 0 ? 'text-green-500' : 'text-red-500'}`}>
                                Delta: {humanReport.trade_counts?.delta ?? 'N/A'}
                            </div>
                        </div>
                    </div>

                    {/* KPIs (Fixed 5) */}
                    <div className="grid grid-cols-5 gap-4">
                        <KPICard label="Gate Open" value={humanReport.kpis?.gate_open_days ?? 'N/A'} color="text-emerald-400" />
                        <KPICard label="Executed" value={humanReport.kpis?.executed_days ?? 'N/A'} color="text-blue-400" />
                        <KPICard label="Chop Block" value={humanReport.kpis?.chop_block_days ?? 'N/A'} color="text-slate-400" />
                        <KPICard label="Bear Block" value={humanReport.kpis?.bear_block_days ?? 'N/A'} color="text-amber-400" />
                        <KPICard label="No Data" value={humanReport.kpis?.no_data_days ?? 'N/A'} color={(humanReport.kpis?.no_data_days ?? 0) > 0 ? "text-red-400" : "text-slate-500"} />
                    </div>

                    {/* Integrity Banners (Drill-down Triggers) */}
                    {(humanReport.integrity_summary.warning_total > 0 || humanReport.integrity_summary.info_total > 0) && (
                        <div className="space-y-2">
                            {humanReport.top_issues.map((issue, idx) => {
                                const isSelected = filteredCode === issue.code;
                                return (
                                    <div key={idx}
                                        onClick={() => toggleFilter(issue.code)}
                                        className={`p-3 rounded flex justify-between items-center cursor-pointer transition-all ${isSelected ? 'bg-amber-900/40 border border-amber-500' : 'bg-slate-800 border border-slate-700 hover:bg-slate-750'}`}>
                                        <div className="flex items-center gap-3">
                                            <span className="text-amber-400 font-bold">‚ö†Ô∏è {issue.title_ko}</span>
                                            <span className="text-slate-400 text-sm">({issue.count} days)</span>
                                        </div>
                                        <div className="text-xs text-slate-500 underline">{issue.action_ko}</div>
                                    </div>
                                )
                            })}
                        </div>
                    )}

                    {/* Daily Log Table */}
                    <div className="bg-slate-900 rounded-xl border border-slate-800 overflow-hidden">
                        <div className="bg-slate-800 px-4 py-2 border-b border-slate-700 flex justify-between items-center">
                            <h3 className="font-bold text-slate-300 text-sm">Daily Reconciliation Log (V1)</h3>
                            <span className="text-xs text-slate-500">
                                {filteredCode ? `Filter Active: ${sortedDaily.length} rows` : `Total Rows: ${sortedDaily.length}`}
                            </span>
                        </div>
                        <div className="max-h-[500px] overflow-y-auto custom-scrollbar">
                            <table className="w-full text-xs text-left">
                                <thead className="text-slate-500 bg-slate-800/50 sticky top-0">
                                    <tr>
                                        <th className="p-3">Date</th>
                                        <th className="p-3">Gate</th>
                                        <th className="p-3">Reason</th>
                                        <th className="p-3">Evidence</th>
                                        <th className="p-3 text-center">Exec</th>
                                        <th className="p-3">Integrity</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-800">
                                    {sortedDaily.map((row, i) => {
                                        const isExec = row.execution?.executed ?? false;
                                        const integrityCodes = row.integrity?.codes || [];
                                        const hasIntegrity = integrityCodes.length > 0;

                                        return (
                                            <tr key={i} className={`hover:bg-slate-800/50 ${isExec ? 'bg-blue-900/10' : ''}`}>
                                                <td className="p-3 font-mono text-slate-400">{row.trade_date}</td>
                                                <td className="p-3 flex items-center">
                                                    <span className={`px-1.5 py-0.5 rounded ${row.final?.gate_decision === 'PASS' ? 'bg-green-900 text-green-300' : 'bg-red-900 text-red-300'}`}>
                                                        {row.final?.gate_decision ?? 'N/A'}
                                                    </span>
                                                </td>
                                                <td className="p-3 text-slate-300">{row.final?.reason ?? 'N/A'}</td>
                                                <td className="p-3 font-mono text-slate-500">
                                                    {row.evidence?.status === 'OK'
                                                        ? `ADX:${row.evidence?.adx ?? 'N/A'} ${row.evidence?.regime ?? 'N/A'}`
                                                        : <span className="text-red-900">{row.evidence?.status ?? 'N/A'}</span>}
                                                </td>
                                                <td className="p-3 text-center">
                                                    {isExec ? <span className="text-blue-400 font-bold">YES</span> : <span className="text-slate-600">-</span>}
                                                </td>
                                                <td className="p-3">
                                                    {hasIntegrity ? (
                                                        <div className="flex flex-wrap gap-1">
                                                            {integrityCodes.map(c => (
                                                                <span key={c} className="bg-amber-900/50 text-amber-400 px-1 rounded border border-amber-900">{c}</span>
                                                            ))}
                                                        </div>
                                                    ) : <span className="text-green-900">OK</span>}
                                                </td>
                                            </tr>
                                        )
                                    })}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        }

        function GatekeeperView({ data }) {
            if (!data || data.status === 'not_ready') {
                return (
                    <div className="flex flex-col items-center justify-center py-20 border border-dashed border-slate-700 rounded-lg opacity-70">
                        <div className="text-4xl mb-4">üõ°Ô∏è</div>
                        <h3 className="text-xl font-bold text-slate-400">Ïã¨ÏÇ¨ Í≤∞Í≥º ÏóÜÏùå (Contract-2 Strict)</h3>
                        <p className="text-sm text-slate-500 mt-2">{data ? data.message : "Tools > Gatekeeper Ïã§Ìñâ ÌïÑÏöî"}</p>
                    </div>
                );
            }

            const badgeColor = {
                "PROMOTE": "bg-emerald-500 text-black",
                "HOLD": "bg-yellow-500 text-black",
                "REJECT": "bg-red-500 text-white",
                "ERROR": "bg-red-600 text-white font-bold animate-pulse"
            }[data.decision.result] || "bg-slate-500";

            return (
                <div className="space-y-8">
                    <div className="bg-slate-800 border border-slate-700 rounded-2xl p-6 flex justify-between items-center shadow-lg">
                        <div>
                            <div className="text-sm text-slate-400 mb-1">Gatekeeper Decision (Contract 2)</div>
                            <h2 className="text-3xl font-bold text-white">{data.decision.reason_ko}</h2>
                            <p className="text-sm text-slate-400 mt-1">Action: {data.decision.recommended_action_ko}</p>
                        </div>
                        <div className={`px-8 py-4 rounded-xl text-3xl font-bold tracking-widest shadow-lg ${badgeColor}`}>
                            {data.decision.result}
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div className="bg-slate-800 border border-slate-700 rounded-xl p-6">
                            <h3 className="text-lg font-bold text-white mb-4 border-b border-slate-700 pb-2">Checks</h3>
                            <div className="space-y-3">
                                {data.checks.map((chk, i) => (
                                    <div key={i} className={`p-4 rounded border ${chk.passed ? 'border-green-500/20 bg-green-500/5' : 'border-red-500/50 bg-red-500/10'}`}>
                                        <div className="flex justify-between items-center mb-1">
                                            <span className={`font-bold ${chk.passed ? 'text-green-300' : 'text-red-300'}`}>{chk.check_id}</span>
                                            <span className={`text-[10px] px-2 py-0.5 rounded ${chk.severity === 'HARD' ? 'bg-red-900 text-red-100' : 'bg-yellow-900 text-yellow-100'}`}>{chk.severity}</span>
                                        </div>
                                        <div className="text-xs text-slate-400 mt-1">{chk.message_ko}</div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div className="bg-slate-800 border border-slate-700 rounded-xl p-6">
                            <h3 className="text-lg font-bold text-white mb-4 border-b border-slate-700 pb-2">Parameter Drift</h3>
                            <table className="w-full text-sm">
                                <thead className="text-slate-500 text-left border-b border-slate-700">
                                    <tr><th className="py-2">Param</th><th className="py-2 text-right">Base</th><th className="py-2 text-right">Cand</th></tr>
                                </thead>
                                <tbody className="text-slate-300 divide-y divide-slate-700">
                                    {data.baseline && data.candidate && Object.keys(data.baseline.params).map(k => {
                                        const bV = JSON.stringify(data.baseline.params[k]);
                                        const cV = JSON.stringify(data.candidate.params[k]);
                                        return (
                                            <tr key={k}>
                                                <td className="py-3 font-mono text-slate-400">{k}</td>
                                                <td className="py-3 text-right">{bV}</td>
                                                <td className={`py-3 text-right font-bold ${bV !== cV ? 'text-amber-400' : ''}`}>{cV}</td>
                                            </tr>
                                        )
                                    })}
                                </tbody>
                            </table>
                            {data.similarity && (
                                <div className="mt-6 flex justify-between items-center bg-slate-900 p-4 rounded-lg">
                                    <span className="text-slate-400">Similarity</span>
                                    <span className="text-2xl font-mono font-bold text-cyan-400">{data.similarity.score_0_1 ? data.similarity.score_0_1.toFixed(2) : 'N/A'}</span>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        function LogViewer({ logFile, content }) {
            if (!logFile) return <div className="p-8 text-center text-slate-500">Î°úÍ∑∏ ÌååÏùº Í≤ΩÎ°ú Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.</div>
            if (content === null) return <div className="p-8 text-center text-cyan-400 animate-pulse">Connecting to Source...</div>
            if (content === "") return <div className="p-8 text-center text-red-400 border border-red-900 bg-red-900/10 rounded">Î°úÍ∑∏ ÌååÏùºÏùÑ ÏùΩÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. (File Not Found or Access Denied)</div>

            return (
                <div className="relative group">
                    <div className="absolute top-2 right-2 px-2 py-1 bg-slate-800 text-xs text-slate-500 rounded font-mono border border-slate-700">
                        {logFile}
                    </div>
                    <pre className="bg-black text-xs md:text-sm font-mono text-emerald-500 p-4 rounded-lg overflow-x-auto whitespace-pre-wrap max-h-[600px] border border-slate-800 shadow-inner custom-scrollbar">
                        {content}
                    </pre>
                </div>
            )
        }

        // Phase C-P.28: Ops Run Receipt Card
        function OpsReceiptCard() {
            const [data, setData] = React.useState(null);
            const [runStatus, setRunStatus] = React.useState(null);
            const [isRunning, setIsRunning] = React.useState(false);
            const [snapshots, setSnapshots] = React.useState([]);
            const [viewerOpen, setViewerOpen] = React.useState(false);
            const [viewerData, setViewerData] = React.useState(null);
            const [viewerLoading, setViewerLoading] = React.useState(false);

            React.useEffect(() => {
                fetchReceipt();
                fetchSnapshots();
            }, []);

            const fetchReceipt = async () => {
                try {
                    const res = await fetch(`${API_BASE}/api/ops/scheduler/latest`);
                    if (res.ok) {
                        const json = await res.json();
                        setData(json);
                    }
                } catch (e) {
                    console.error("Ops Receipt fetch error:", e);
                }
            };

            const fetchSnapshots = async () => {
                try {
                    const res = await fetch(`${API_BASE}/api/ops/scheduler/snapshots`);
                    if (res.ok) {
                        const json = await res.json();
                        setSnapshots(json.rows || []);
                    }
                } catch (e) {
                    console.error("Snapshots fetch error:", e);
                }
            };

            const handleViewSnapshot = async (snapshotId) => {
                setViewerLoading(true);
                setViewerOpen(true);
                try {
                    const res = await fetch(`${API_BASE}/api/ops/scheduler/snapshots/${snapshotId}`);
                    const json = await res.json();
                    setViewerData(json);
                } catch (e) {
                    setViewerData({ error: e.message });
                } finally {
                    setViewerLoading(false);
                }
            };

            const handleCopyJson = () => {
                if (viewerData && viewerData.data) {
                    navigator.clipboard.writeText(JSON.stringify(viewerData.data, null, 2));
                }
            };

            // C-P.30: Evidence Ref Resolver
            const handleResolveRef = async (refValue) => {
                setViewerLoading(true);
                setViewerOpen(true);
                try {
                    const res = await fetch(`${API_BASE}/api/evidence/resolve?ref=${encodeURIComponent(refValue)}`);
                    const json = await res.json();
                    if (res.ok && json.status === 'ready' && json.rows && json.rows[0]) {
                        setViewerData({
                            snapshot_id: json.rows[0].ref,
                            data: json.rows[0].data,
                            source: json.rows[0].source
                        });
                    } else {
                        setViewerData({ error: json.error || json.detail?.error || { message: 'Unknown error' } });
                    }
                } catch (e) {
                    setViewerData({ error: { message: e.message } });
                } finally {
                    setViewerLoading(false);
                }
            };

            // Ref Ìå®ÌÑ¥ Í∞êÏßÄ Î∞è ÌÅ¥Î¶≠ Í∞ÄÎä•ÌïòÍ≤å Î†åÎçîÎßÅ
            const renderJsonWithRefLinks = (data) => {
                const jsonStr = JSON.stringify(data, null, 2);
                // ref Ìå®ÌÑ¥: *.jsonl:line\d+ ÎòêÎäî reports/ops/**/*.json
                const refPattern = /(state\/[a-z\/]+\.jsonl:line\d+|reports\/ops\/[a-zA-Z0-9_\/\-\.]+\.json)/g;

                const parts = jsonStr.split(refPattern);
                const matches = jsonStr.match(refPattern) || [];

                return parts.map((part, idx) => {
                    if (idx < parts.length - 1) {
                        const ref = matches[idx - Math.floor(idx / 2)] || matches[Math.floor(idx / 2)];
                        if (ref && jsonStr.includes(ref)) {
                            return (
                                <React.Fragment key={idx}>
                                    {part}
                                    <span
                                        className="text-cyan-400 underline cursor-pointer hover:text-cyan-300"
                                        onClick={() => handleResolveRef(ref)}
                                    >
                                        {ref}
                                    </span>
                                </React.Fragment>
                            );
                        }
                    }
                    return <React.Fragment key={idx}>{part}</React.Fragment>;
                });
            };

            const handleRunCycle = async () => {
                // Clumsy Finger Protection
                if (!confirm("Ï†ïÎßê Ops CycleÏùÑ Ïã§ÌñâÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n(Í∏∞Î≥∏ Î™®Îìú: DRY_RUN)")) {
                    return;
                }

                setIsRunning(true);
                setRunStatus(null);
                try {
                    const res = await fetch(`${API_BASE}/api/ops/cycle/run`, { method: 'POST' });
                    const json = await res.json();
                    setRunStatus({
                        ok: res.ok,
                        status: json.overall_status || "UNKNOWN",
                        message: json.message || json.reason || "Ïã§Ìñâ ÏôÑÎ£å"
                    });
                    // Refresh receipt after run
                    setTimeout(fetchReceipt, 1000);
                } catch (e) {
                    setRunStatus({
                        ok: false,
                        status: "ERROR",
                        message: e.message || "Ïã§Ìñâ Ïã§Ìå®"
                    });
                } finally {
                    setIsRunning(false);
                }
            };

            // Empty State: No Run History
            if (!data || data.status === 'not_ready') {
                return (
                    <div className="bg-gradient-to-br from-slate-800/50 to-slate-900 border border-slate-700/50 rounded-2xl p-6">
                        <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2">
                            <span className="w-1 h-5 bg-purple-500 rounded"></span> Ops Run Receipt
                            <span className="ml-2 px-2 py-0.5 rounded text-xs font-bold bg-slate-600/50 text-slate-400 border border-slate-600/30">NO DATA</span>
                        </h3>
                        <div className="text-center py-8 text-slate-500 bg-slate-900/50 rounded-lg border border-dashed border-slate-700">
                            <div className="text-3xl mb-2">üìã</div>
                            <div className="font-semibold">No Run History</div>
                            <div className="text-sm mt-1">ÏïÑÏßÅ Ops Cycle Ïã§Ìñâ Ïù¥Î†•Ïù¥ ÏóÜÏäµÎãàÎã§.</div>
                        </div>
                        <button
                            onClick={handleRunCycle}
                            disabled={isRunning}
                            className="mt-4 w-full py-2 rounded-lg font-bold text-white bg-purple-600 hover:bg-purple-500 disabled:bg-slate-700 disabled:text-slate-500 transition"
                        >
                            {isRunning ? 'Ïã§Ìñâ Ï§ë...' : '‚ñ∂ Run Ops Cycle'}
                        </button>
                    </div>
                );
            }

            const receipt = data.rows && data.rows[0];
            if (!receipt) return null;

            const statusColor = {
                'DONE': 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30',
                'SKIPPED': 'bg-slate-500/20 text-slate-400 border-slate-500/30',
                'BLOCKED': 'bg-amber-500/20 text-amber-400 border-amber-500/30',
                'STOPPED': 'bg-red-500/20 text-red-400 border-red-500/30'
            };

            const reasonBadge = (reason) => {
                if (!reason) return null;
                const colors = {
                    'NO_OPEN_TICKETS': 'bg-slate-600/30 text-slate-400',
                    'NO_MESSAGES': 'bg-amber-600/30 text-amber-400',
                    'NOT_REAL_GATE': 'bg-cyan-600/30 text-cyan-400',
                    'SENDER_DISABLED': 'bg-slate-600/30 text-slate-400',
                    'WINDOW_INACTIVE': 'bg-amber-600/30 text-amber-400'
                };
                return <span className={`ml-2 px-2 py-0.5 rounded text-xs ${colors[reason] || 'bg-slate-600/30 text-slate-400'}`}>{reason}</span>;
            };

            const liveFireStep = receipt.live_fire_step || {};
            const ticketStep = receipt.ticket_step || {};
            const pushStep = receipt.push_delivery_step || {};
            const modes = receipt.observed_modes || {};

            return (
                <div className="bg-gradient-to-br from-purple-900/30 to-slate-900 border border-purple-700/50 rounded-2xl p-6">
                    <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2">
                        <span className="w-1 h-5 bg-purple-500 rounded"></span> Ops Run Receipt
                        <span className={`ml-2 px-2 py-0.5 rounded text-xs font-bold border ${statusColor[ticketStep.decision] || statusColor['SKIPPED']}`}>
                            {ticketStep.decision || 'N/A'}
                        </span>
                        <span className="text-xs font-mono text-slate-500 ml-auto">{receipt.asof?.slice(0, 16)}</span>
                    </h3>

                    {/* Observed Modes */}
                    <div className="grid grid-cols-5 gap-2 mb-4 text-xs">
                        <div className={`p-2 rounded border ${modes.gate_mode === 'REAL_ENABLED' ? 'bg-red-900/30 border-red-700/50 text-red-400' : 'bg-slate-800/50 border-slate-700/50 text-slate-400'}`}>
                            <div className="font-bold">Gate</div>
                            <div className="font-mono">{modes.gate_mode || 'N/A'}</div>
                        </div>
                        <div className={`p-2 rounded border ${modes.sender_enable ? 'bg-red-900/30 border-red-700/50 text-red-400' : 'bg-slate-800/50 border-slate-700/50 text-slate-400'}`}>
                            <div className="font-bold">Sender</div>
                            <div className="font-mono">{modes.sender_enable ? 'ON' : 'OFF'}</div>
                        </div>
                        <div className={`p-2 rounded border ${modes.window_active ? 'bg-emerald-900/30 border-emerald-700/50 text-emerald-400' : 'bg-slate-800/50 border-slate-700/50 text-slate-400'}`}>
                            <div className="font-bold">Window</div>
                            <div className="font-mono">{modes.window_active ? 'ACTIVE' : 'INACTIVE'}</div>
                        </div>
                        <div className={`p-2 rounded border ${modes.emergency_stop ? 'bg-red-900/30 border-red-700/50 text-red-400' : 'bg-emerald-900/30 border-emerald-700/50 text-emerald-400'}`}>
                            <div className="font-bold">E-Stop</div>
                            <div className="font-mono">{modes.emergency_stop ? 'ON' : 'OFF'}</div>
                        </div>
                        <div className="p-2 rounded border bg-slate-800/50 border-slate-700/50 text-slate-400">
                            <div className="font-bold">Ext Send</div>
                            <div className="font-mono">{receipt.external_send_count || 0}</div>
                        </div>
                    </div>

                    {/* Steps Summary */}
                    <div className="grid grid-cols-3 gap-3 text-sm">
                        <div className="p-3 bg-slate-800/50 rounded-lg border border-slate-700/30">
                            <div className="font-bold text-slate-300 mb-1">Ticket Step</div>
                            <div className={`font-mono ${ticketStep.decision === 'DONE' ? 'text-emerald-400' : 'text-slate-400'}`}>
                                {ticketStep.decision || 'N/A'}
                                {ticketStep.reason === 'NO_OPEN_TICKETS' && <span className="ml-1 text-xs text-slate-500">(No Open Tickets)</span>}
                            </div>
                        </div>
                        <div className="p-3 bg-slate-800/50 rounded-lg border border-slate-700/30">
                            <div className="font-bold text-slate-300 mb-1">Push Delivery</div>
                            <div className={`font-mono ${pushStep.decision === 'DONE' ? 'text-emerald-400' : 'text-slate-400'}`}>
                                {pushStep.decision || 'N/A'}
                            </div>
                        </div>
                        <div className="p-3 bg-slate-800/50 rounded-lg border border-slate-700/30">
                            <div className="font-bold text-slate-300 mb-1">Live Fire</div>
                            <div className={`font-mono ${liveFireStep.decision === 'DONE' ? 'text-emerald-400' : liveFireStep.decision === 'BLOCKED' ? 'text-amber-400' : 'text-slate-400'}`}>
                                {liveFireStep.decision || 'N/A'}
                                {reasonBadge(liveFireStep.reason)}
                            </div>
                            {liveFireStep.live_fire_receipt_ref && (
                                <div className="text-xs text-slate-500 mt-1 font-mono truncate">ref: {liveFireStep.live_fire_receipt_ref}</div>
                            )}
                        </div>
                    </div>

                    {/* Run Button + Status */}
                    <div className="mt-4 flex items-center gap-3">
                        <button
                            onClick={handleRunCycle}
                            disabled={isRunning}
                            className="flex-1 py-2 rounded-lg font-bold text-white bg-purple-600 hover:bg-purple-500 disabled:bg-slate-700 disabled:text-slate-500 transition"
                        >
                            {isRunning ? 'Ïã§Ìñâ Ï§ë...' : '‚ñ∂ Run Ops Cycle'}
                        </button>
                        {runStatus && (
                            <div className={`px-3 py-2 rounded-lg text-sm font-mono ${runStatus.ok ? 'bg-emerald-900/30 text-emerald-400' : 'bg-red-900/30 text-red-400'}`}>
                                {runStatus.status}: {runStatus.message}
                            </div>
                        )}
                    </div>

                    {/* Recent Runs (C-P.29) */}
                    {snapshots.length > 0 && (
                        <div className="mt-4 border-t border-slate-700/50 pt-4">
                            <div className="text-sm font-bold text-slate-400 mb-2">üìÅ Recent Runs</div>
                            <div className="space-y-1 max-h-32 overflow-y-auto">
                                {snapshots.slice(0, 5).map((snap, idx) => (
                                    <div key={idx} className="flex items-center justify-between text-xs bg-slate-800/50 px-3 py-2 rounded border border-slate-700/30">
                                        <span className="font-mono text-slate-400 truncate flex-1">{snap.snapshot_id || snap.filename}</span>
                                        <span className="text-slate-500 mx-2">{snap.mtime?.slice(0, 16)}</span>
                                        <button
                                            onClick={() => handleViewSnapshot(snap.snapshot_id || snap.filename)}
                                            className="px-2 py-1 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded text-xs transition"
                                        >
                                            View
                                        </button>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* Snapshot Viewer Modal (C-P.29) */}
                    {viewerOpen && (
                        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50" onClick={() => setViewerOpen(false)}>
                            <div className="bg-slate-900 border border-slate-700 rounded-2xl p-6 w-full max-w-3xl max-h-[80vh] overflow-hidden flex flex-col" onClick={e => e.stopPropagation()}>
                                <div className="flex items-center justify-between mb-4">
                                    <h4 className="text-lg font-bold text-white flex items-center gap-2">
                                        <span className="w-1 h-5 bg-purple-500 rounded"></span>
                                        Snapshot Viewer
                                        <span className="text-xs text-slate-500 font-mono ml-2">{viewerData?.snapshot_id || ''}</span>
                                    </h4>
                                    <div className="flex items-center gap-2">
                                        <button onClick={handleCopyJson} className="px-3 py-1 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded text-xs transition">
                                            üìã Copy JSON
                                        </button>
                                        <button onClick={() => setViewerOpen(false)} className="px-3 py-1 bg-red-900/50 hover:bg-red-800 text-red-300 rounded text-xs transition">
                                            ‚úï Close
                                        </button>
                                    </div>
                                </div>
                                <div className="flex-1 overflow-auto bg-black rounded-lg border border-slate-800">
                                    {viewerLoading ? (
                                        <div className="p-8 text-center text-cyan-400 animate-pulse">Loading...</div>
                                    ) : viewerData?.error ? (
                                        <div className="p-8 text-center text-red-400">{viewerData.error.message || viewerData.error}</div>
                                    ) : (
                                        <pre className="p-4 text-xs font-mono text-emerald-400 whitespace-pre-wrap">
                                            {viewerData?.data ? renderJsonWithRefLinks(viewerData.data) : ''}
                                        </pre>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Phase C-P.35: Ops Summary Card (Single Pane of Glass)
        // Phase C-P.46: Added Evidence Ref Preview with JSONL_LINE support
        function OpsSummaryCard() {
            const [data, setData] = React.useState(null);
            const [isRegenerating, setIsRegenerating] = React.useState(false);
            const [viewerOpen, setViewerOpen] = React.useState(false);
            const [viewerData, setViewerData] = React.useState(null);
            const [viewerLoading, setViewerLoading] = React.useState(false);

            React.useEffect(() => {
                fetchSummary();
            }, []);

            // C-P.46: Evidence Ref Resolver with JSONL_LINE preview
            const handleResolveRef = async (refValue) => {
                setViewerLoading(true);
                setViewerOpen(true);
                setViewerData(null);
                try {
                    const res = await fetch(`${API_BASE}/api/evidence/resolve?ref=${encodeURIComponent(refValue)}`);
                    const json = await res.json();
                    if (res.ok && json.status === 'ready' && json.rows && json.rows[0]) {
                        setViewerData({
                            ref: json.rows[0].ref,
                            data: json.rows[0].data,
                            source: json.rows[0].source,
                            status: 'success'
                        });
                    } else {
                        // Graceful error handling for 400/404/500
                        const errorCode = json.error?.code || (res.status === 404 ? 'NOT_FOUND' : 'INVALID_REF');
                        setViewerData({
                            status: 'error',
                            errorCode: errorCode,
                            errorMessage: json.error?.message || json.detail?.error?.message || 'Unknown error'
                        });
                    }
                } catch (e) {
                    setViewerData({
                        status: 'error',
                        errorCode: 'NETWORK_ERROR',
                        errorMessage: e.message
                    });
                } finally {
                    setViewerLoading(false);
                }
            };

            const fetchSummary = async () => {
                try {
                    const res = await fetch(`${API_BASE}/api/ops/summary/latest`);
                    if (res.ok) {
                        const json = await res.json();
                        setData(json.rows?.[0] || null);
                    }
                } catch (e) {
                    console.error("Ops summary fetch error:", e);
                }
            };

            const handleRegenerate = async () => {
                if (!confirm("Ï†ïÎßê Ops SummaryÎ•º Ïû¨ÏÉùÏÑ±ÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) return;
                setIsRegenerating(true);
                try {
                    const res = await fetch(`${API_BASE}/api/ops/summary/regenerate`, { method: 'POST' });
                    if (res.ok) fetchSummary();
                } catch (e) {
                    console.error("Regenerate error:", e);
                } finally {
                    setIsRegenerating(false);
                }
            };

            const statusBadge = (status) => {
                const colors = {
                    OK: 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30',
                    WARN: 'bg-amber-500/20 text-amber-400 border-amber-500/30',
                    BLOCKED: 'bg-red-500/20 text-red-400 border-red-500/30',
                    STOPPED: 'bg-red-700/30 text-red-300 border-red-500/50',
                    NO_RUN_HISTORY: 'bg-slate-500/20 text-slate-400 border-slate-500/30'
                };
                return `px-3 py-1 rounded-full text-sm font-bold border ${colors[status] || colors.NO_RUN_HISTORY}`;
            };

            // Empty State
            if (!data || data.overall_status === 'NO_RUN_HISTORY') {
                return (
                    <div className="bg-gradient-to-br from-indigo-900/40 to-slate-900 border border-indigo-700/50 rounded-2xl p-6 col-span-2">
                        <h3 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
                            <span className="w-1.5 h-6 bg-indigo-500 rounded"></span> Ops Summary
                            <span className={statusBadge('NO_RUN_HISTORY')}>NO RUN HISTORY</span>
                        </h3>
                        <div className="text-center py-8 text-slate-500">
                            <div className="text-4xl mb-3">üìä</div>
                            <div className="text-lg font-semibold">No Run History</div>
                            <div className="text-sm mt-2">Generate summary to view system status</div>
                        </div>
                        <button onClick={handleRegenerate} disabled={isRegenerating}
                            className="mt-4 w-full py-3 rounded-lg font-bold text-white bg-indigo-600 hover:bg-indigo-500 disabled:bg-slate-700 disabled:text-slate-500 transition">
                            {isRegenerating ? 'ÏÉùÏÑ± Ï§ë...' : 'üîÑ Generate Summary'}
                        </button>
                    </div>
                );
            }

            const guard = data.guard || {};
            const tickets = data.tickets || {};
            const push = data.push || {};
            const triplet = data.last_run_triplet || {};
            const risks = data.top_risks || [];

            return (
                <div className="bg-gradient-to-br from-indigo-900/40 to-slate-900 border border-indigo-700/50 rounded-2xl p-6 col-span-2">
                    <h3 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
                        <span className="w-1.5 h-6 bg-indigo-500 rounded"></span> Ops Summary
                        <span className={statusBadge(data.overall_status)}>{data.overall_status}</span>
                        <span className="text-xs font-mono text-slate-500 ml-auto">{data.asof?.slice(0, 16)}</span>
                    </h3>

                    {/* Guard Section */}
                    <div className="grid grid-cols-3 gap-4 mb-4">
                        <div className="bg-slate-800/50 rounded-lg p-3 border border-slate-700">
                            <div className="text-xs text-slate-500 mb-1">Emergency Stop</div>
                            <div className={`font-bold ${guard.emergency_stop?.enabled ? 'text-red-400' : 'text-emerald-400'}`}>
                                {guard.emergency_stop?.enabled ? 'üö® ACTIVE' : '‚úÖ OFF'}
                            </div>
                        </div>
                        <div className="bg-slate-800/50 rounded-lg p-3 border border-slate-700">
                            <div className="text-xs text-slate-500 mb-1">Gate Mode</div>
                            <div className="font-bold text-cyan-400">{guard.execution_gate?.mode || 'N/A'}</div>
                        </div>
                        <div className="bg-slate-800/50 rounded-lg p-3 border border-slate-700">
                            <div className="text-xs text-slate-500 mb-1">Evidence Health</div>
                            <div className={`font-bold ${guard.evidence_health?.decision === 'PASS' ? 'text-emerald-400' : guard.evidence_health?.decision === 'WARN' ? 'text-amber-400' : 'text-red-400'}`}>
                                {guard.evidence_health?.decision || 'N/A'}
                            </div>
                        </div>
                    </div>

                    {/* Tickets & Push */}
                    <div className="grid grid-cols-2 gap-4 mb-4">
                        <div className="bg-slate-800/50 rounded-lg p-3 border border-slate-700">
                            <div className="text-xs text-slate-500 mb-2">Tickets</div>
                            <div className="flex gap-2 text-xs">
                                <span className="px-2 py-1 bg-blue-900/30 rounded text-blue-400">Open: {tickets.open}</span>
                                <span className="px-2 py-1 bg-emerald-900/30 rounded text-emerald-400">Done: {tickets.done}</span>
                                <span className="px-2 py-1 bg-red-900/30 rounded text-red-400">Failed: {tickets.failed}</span>
                            </div>
                        </div>
                        <div className="bg-slate-800/50 rounded-lg p-3 border border-slate-700">
                            <div className="text-xs text-slate-500 mb-2">Push</div>
                            <div className="flex gap-2 text-xs">
                                <span className="px-2 py-1 bg-purple-900/30 rounded text-purple-400">Outbox: {push.outbox_row_count}</span>
                                <span className={`px-2 py-1 rounded ${push.sender_enabled ? 'bg-emerald-900/30 text-emerald-400' : 'bg-slate-700 text-slate-400'}`}>
                                    Sender: {push.sender_enabled ? 'ON' : 'OFF'}
                                </span>
                            </div>
                        </div>
                    </div>

                    {/* Top Risks */}
                    {risks.length > 0 && (
                        <div className="mb-4">
                            <div className="text-xs text-slate-500 mb-2 font-bold">‚ö†Ô∏è Top Risks</div>
                            <div className="space-y-1">
                                {risks.slice(0, 3).map((risk, i) => (
                                    <div key={i} className={`px-3 py-2 rounded text-sm ${risk.severity === 'CRITICAL' ? 'bg-red-900/30 text-red-400' : 'bg-amber-900/30 text-amber-400'}`}>
                                        <div className="flex items-center gap-2">
                                            <span className="font-mono text-xs">{risk.code}</span>
                                            <span className="text-slate-400">‚Äî</span>
                                            <span>{risk.message}</span>
                                        </div>
                                        {risk.evidence_refs && risk.evidence_refs.length > 0 && (
                                            <div className="mt-1 pl-2 flex flex-wrap gap-1">
                                                {risk.evidence_refs.map((ref, j) => (
                                                    <a key={j} href="#" onClick={(e) => { e.preventDefault(); handleResolveRef(ref); }}
                                                        className="text-xs text-cyan-400 hover:text-cyan-300 underline font-mono">
                                                        üìé {ref.split('/').pop()}
                                                    </a>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    <button onClick={handleRegenerate} disabled={isRegenerating}
                        className="w-full py-2 rounded-lg font-bold text-white bg-indigo-600 hover:bg-indigo-500 disabled:bg-slate-700 disabled:text-slate-500 transition">
                        {isRegenerating ? 'ÏÉùÏÑ± Ï§ë...' : 'üîÑ Regenerate'}
                    </button>

                    {/* C-P.46: Evidence Viewer Modal with JSONL_LINE Preview */}
                    {viewerOpen && (
                        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50" onClick={() => setViewerOpen(false)}>
                            <div className="bg-slate-900 border border-slate-700 rounded-2xl p-6 w-full max-w-2xl max-h-[80vh] overflow-hidden flex flex-col" onClick={e => e.stopPropagation()}>
                                <div className="flex items-center justify-between mb-4">
                                    <h4 className="text-lg font-bold text-white flex items-center gap-2">
                                        <span className="w-1 h-5 bg-indigo-500 rounded"></span>
                                        Evidence Preview
                                    </h4>
                                    <button onClick={() => setViewerOpen(false)} className="px-3 py-1 bg-red-900/50 hover:bg-red-800 text-red-300 rounded text-xs transition">
                                        ‚úï Close
                                    </button>
                                </div>

                                {/* Ref Display */}
                                {viewerData?.ref && (
                                    <div className="text-xs text-slate-500 font-mono mb-3 bg-slate-800/50 px-3 py-2 rounded truncate">
                                        {viewerData.ref}
                                    </div>
                                )}

                                <div className="flex-1 overflow-auto">
                                    {viewerLoading ? (
                                        <div className="p-8 text-center text-cyan-400 animate-pulse">Loading...</div>
                                    ) : viewerData?.status === 'error' ? (
                                        <div className="p-6 text-center bg-red-900/20 rounded-lg border border-red-800">
                                            <div className="text-red-400 font-bold text-lg mb-2">{viewerData.errorCode}</div>
                                            <div className="text-red-300 text-sm">{viewerData.errorMessage}</div>
                                        </div>
                                    ) : viewerData?.source?.kind === 'JSONL_LINE' ? (
                                        /* JSONL_LINE Specialized Preview */
                                        <div className="space-y-3">
                                            <div className="grid grid-cols-2 gap-3">
                                                <div className="bg-slate-800/50 p-3 rounded-lg border border-slate-700">
                                                    <div className="text-xs text-slate-500 mb-1">Line</div>
                                                    <div className="text-lg font-mono font-bold text-cyan-400">{viewerData.source.line}</div>
                                                </div>
                                                <div className="bg-slate-800/50 p-3 rounded-lg border border-slate-700">
                                                    <div className="text-xs text-slate-500 mb-1">Status</div>
                                                    <div className={`text-lg font-bold ${viewerData.data?.status === 'DONE' ? 'text-emerald-400' :
                                                        viewerData.data?.status === 'FAILED' ? 'text-red-400' :
                                                            viewerData.data?.status === 'BLOCKED' ? 'text-amber-400' : 'text-slate-300'
                                                        }`}>{viewerData.data?.status || 'N/A'}</div>
                                                </div>
                                            </div>
                                            <div className="bg-slate-800/50 p-3 rounded-lg border border-slate-700">
                                                <div className="text-xs text-slate-500 mb-1">Processor ID</div>
                                                <div className="text-sm font-mono text-slate-300">{viewerData.data?.processor_id || 'N/A'}</div>
                                            </div>
                                            <div className="bg-slate-800/50 p-3 rounded-lg border border-slate-700">
                                                <div className="text-xs text-slate-500 mb-1">Message</div>
                                                <div className="text-sm text-slate-300 line-clamp-2">
                                                    {viewerData.data?.message ? (viewerData.data.message.length > 150 ? viewerData.data.message.slice(0, 150) + '...' : viewerData.data.message) : 'N/A'}
                                                </div>
                                            </div>
                                            {/* Full JSON (collapsed) */}
                                            <details className="bg-black rounded-lg border border-slate-800">
                                                <summary className="px-3 py-2 text-xs text-slate-500 cursor-pointer hover:text-slate-400">View Full JSON</summary>
                                                <pre className="p-3 text-xs font-mono text-emerald-400 whitespace-pre-wrap overflow-auto max-h-48">
                                                    {JSON.stringify(viewerData.data, null, 2)}
                                                </pre>
                                            </details>
                                        </div>
                                    ) : (
                                        /* Generic JSON Preview */
                                        <pre className="p-4 text-xs font-mono text-emerald-400 whitespace-pre-wrap bg-black rounded-lg border border-slate-800">
                                            {JSON.stringify(viewerData?.data, null, 2)}
                                        </pre>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Phase D-P.48: Reco Card (Recommendation Report)
        function RecoCard() {
            const [data, setData] = React.useState(null);
            const [isRegenerating, setIsRegenerating] = React.useState(false);
            const [error, setError] = React.useState(null);

            React.useEffect(() => {
                fetchReco();
            }, []);

            const fetchReco = async () => {
                try {
                    const res = await fetch(`${API_BASE}/api/reco/latest`);
                    if (res.ok) {
                        const json = await res.json();
                        setData(json);
                        setError(null);
                    }
                } catch (e) {
                    console.error("Reco fetch error:", e);
                    setError(e.message);
                }
            };

            const handleRegenerate = async () => {
                if (!confirm("Ï∂îÏ≤ú Î¶¨Ìè¨Ìä∏Î•º Ïû¨ÏÉùÏÑ±ÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n(Ï†ÑÎûµ Î≤àÎì§ Í∏∞Î∞òÏúºÎ°ú ÏÉà Ï∂îÏ≤úÏù¥ ÏÉùÏÑ±Îê©ÎãàÎã§)")) {
                    return;
                }
                setIsRegenerating(true);
                try {
                    const res = await fetch(`${API_BASE}/api/reco/regenerate`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ confirm: true })
                    });
                    const json = await res.json();
                    if (res.ok && json.result === 'OK') {
                        await fetchReco();
                    } else {
                        alert(`Ïû¨ÏÉùÏÑ± Ïã§Ìå®: ${json.message || json.reason || 'Unknown error'}`);
                    }
                } catch (e) {
                    alert(`Error: ${e.message}`);
                }
                setIsRegenerating(false);
            };

            const report = data?.report;
            const summary = report?.summary;
            const recos = report?.recommendations || [];

            const decisionColor = {
                'GENERATED': 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30',
                'EMPTY_RECO': 'bg-amber-500/20 text-amber-400 border-amber-500/30',
                'BLOCKED': 'bg-red-500/20 text-red-400 border-red-500/30',
                'NO_RECO_YET': 'bg-slate-700 text-slate-400 border-slate-600'
            }[report?.decision || data?.summary?.decision || 'NO_RECO_YET'];

            return (
                <div className="bg-slate-800 border border-slate-700 rounded-2xl p-6">
                    <div className="flex items-center justify-between mb-6">
                        <h2 className="text-lg font-bold text-white flex items-center gap-2">
                            <span className="w-1 h-5 bg-purple-500 rounded"></span>
                            üìä Recommendations
                            <span className="text-xs text-slate-500 font-mono">(D-P.48)</span>
                        </h2>
                        <div className="flex items-center gap-3">
                            <span className={`px-3 py-1 rounded-full text-xs font-bold border ${decisionColor}`}>
                                {report?.decision || data?.summary?.decision || 'NO_RECO_YET'}
                            </span>
                            <button
                                onClick={handleRegenerate}
                                disabled={isRegenerating}
                                className="px-3 py-1 bg-purple-600 hover:bg-purple-500 disabled:bg-slate-700 text-white text-xs font-bold rounded transition"
                            >
                                {isRegenerating ? 'ÏÉùÏÑ± Ï§ë...' : 'üîÑ Regenerate'}
                            </button>
                        </div>
                    </div>

                    {/* No Reco State */}
                    {(!report || data?.status === 'no_reco_yet') && (
                        <div className="text-center py-8 bg-slate-900/50 rounded-lg border border-dashed border-slate-700">
                            <div className="text-4xl mb-3">üí°</div>
                            <div className="text-slate-400 font-bold">Ï∂îÏ≤ú Î¶¨Ìè¨Ìä∏ ÏóÜÏùå</div>
                            <div className="text-sm text-slate-500 mt-1">Regenerate Î≤ÑÌäºÏùÑ ÎàåÎü¨ Ï†ÑÎûµ Î≤àÎì§ Í∏∞Î∞ò Ï∂îÏ≤úÏùÑ ÏÉùÏÑ±ÌïòÏÑ∏Ïöî.</div>
                        </div>
                    )}

                    {/* Report Content */}
                    {report && (
                        <div className="space-y-4">
                            {/* Source Bundle Info */}
                            {report.source_bundle && (
                                <div className="bg-slate-900/50 border border-slate-700/50 rounded-lg p-3 text-xs">
                                    <div className="text-slate-500 mb-1">Source Bundle</div>
                                    <div className="flex items-center gap-4">
                                        <span className="text-cyan-400 font-mono">{report.source_bundle.strategy_name} v{report.source_bundle.strategy_version}</span>
                                        <span className="text-slate-500">ID: {report.source_bundle.bundle_id?.slice(0, 8)}...</span>
                                        <span className={`px-2 py-0.5 rounded text-xs ${report.source_bundle.bundle_decision === 'PASS' ? 'bg-emerald-900/50 text-emerald-400' : 'bg-amber-900/50 text-amber-400'}`}>
                                            {report.source_bundle.bundle_decision}
                                        </span>
                                    </div>
                                </div>
                            )}

                            {/* Summary Grid */}
                            {summary && (
                                <div className="grid grid-cols-5 gap-3">
                                    <div className="bg-slate-900/50 p-3 rounded-lg border border-slate-700/50 text-center">
                                        <div className="text-[10px] text-slate-500 uppercase">Total</div>
                                        <div className="text-xl font-bold text-white font-mono">{summary.total_positions}</div>
                                    </div>
                                    <div className="bg-emerald-900/20 p-3 rounded-lg border border-emerald-700/30 text-center">
                                        <div className="text-[10px] text-emerald-400 uppercase">Buy</div>
                                        <div className="text-xl font-bold text-emerald-400 font-mono">{summary.buy_count}</div>
                                    </div>
                                    <div className="bg-red-900/20 p-3 rounded-lg border border-red-700/30 text-center">
                                        <div className="text-[10px] text-red-400 uppercase">Sell</div>
                                        <div className="text-xl font-bold text-red-400 font-mono">{summary.sell_count}</div>
                                    </div>
                                    <div className="bg-slate-800/50 p-3 rounded-lg border border-slate-700/50 text-center">
                                        <div className="text-[10px] text-slate-500 uppercase">Hold</div>
                                        <div className="text-xl font-bold text-slate-300 font-mono">{summary.hold_count}</div>
                                    </div>
                                    <div className="bg-cyan-900/20 p-3 rounded-lg border border-cyan-700/30 text-center">
                                        <div className="text-[10px] text-cyan-400 uppercase">Cash</div>
                                        <div className="text-xl font-bold text-cyan-400 font-mono">{((summary.cash_pct || 0) * 100).toFixed(0)}%</div>
                                    </div>
                                </div>
                            )}

                            {/* Recommendations List */}
                            {recos.length > 0 && (
                                <div className="space-y-2">
                                    <div className="text-sm font-bold text-slate-400">üìã Recommendations</div>
                                    {recos.map((r, idx) => (
                                        <div key={idx} className="flex items-center justify-between bg-slate-900/50 border border-slate-700/50 px-4 py-3 rounded-lg hover:border-purple-500/30 transition">
                                            <div className="flex items-center gap-3">
                                                <span className={`px-2 py-1 rounded font-bold text-xs ${r.action === 'BUY' ? 'bg-emerald-900/50 text-emerald-400 border border-emerald-500/30' :
                                                    r.action === 'SELL' ? 'bg-red-900/50 text-red-400 border border-red-500/30' :
                                                        'bg-slate-700 text-slate-400'}`}>{r.action}</span>
                                                <span className="font-mono text-white font-bold">{r.ticker}</span>
                                                <span className="text-slate-400 text-sm">{r.name}</span>
                                            </div>
                                            <div className="flex items-center gap-4 text-sm">
                                                <span className="text-slate-500">Weight: <span className="text-cyan-400 font-mono">{((r.weight_pct || 0) * 100).toFixed(0)}%</span></span>
                                                <span className="text-slate-500">Score: <span className={`font-mono ${r.signal_score >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{(r.signal_score || 0).toFixed(2)}</span></span>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}

                            {/* Reason if EMPTY or BLOCKED */}
                            {(report.decision === 'EMPTY_RECO' || report.decision === 'BLOCKED') && (
                                <div className={`p-4 rounded-lg border ${report.decision === 'BLOCKED' ? 'bg-red-900/20 border-red-700/30 text-red-300' : 'bg-amber-900/20 border-amber-700/30 text-amber-300'}`}>
                                    <div className="font-bold mb-1">{report.decision === 'BLOCKED' ? '‚õî Generation Blocked' : '‚ö†Ô∏è Empty Recommendations'}</div>
                                    <div className="text-sm opacity-80">Reason: {report.reason}</div>
                                </div>
                            )}

                            {/* Meta Info */}
                            <div className="text-xs text-slate-500 flex items-center gap-4 pt-2 border-t border-slate-700/50">
                                <span>Report ID: <span className="font-mono text-slate-400">{report.report_id?.slice(0, 8)}...</span></span>
                                <span>Created: <span className="font-mono text-slate-400">{report.created_at?.slice(0, 19)}</span></span>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Phase C-P.31: Evidence Index Card
        function EvidenceCard() {
            const [data, setData] = React.useState(null);
            const [isRegenerating, setIsRegenerating] = React.useState(false);
            const [viewerOpen, setViewerOpen] = React.useState(false);
            const [viewerData, setViewerData] = React.useState(null);
            const [viewerLoading, setViewerLoading] = React.useState(false);

            React.useEffect(() => {
                fetchIndex();
            }, []);

            const fetchIndex = async () => {
                try {
                    const res = await fetch(`${API_BASE}/api/evidence/index/latest`);
                    if (res.ok) {
                        const json = await res.json();
                        setData(json);
                    }
                } catch (e) {
                    console.error("Evidence index fetch error:", e);
                }
            };

            const handleRegenerate = async () => {
                if (!confirm("Ï†ïÎßê Evidence IndexÎ•º Ïû¨ÏÉùÏÑ±ÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) {
                    return;
                }
                setIsRegenerating(true);
                try {
                    const res = await fetch(`${API_BASE}/api/evidence/index/regenerate`, { method: 'POST' });
                    if (res.ok) {
                        fetchIndex();
                    }
                } catch (e) {
                    console.error("Regenerate error:", e);
                } finally {
                    setIsRegenerating(false);
                }
            };

            const handleViewEvidence = async (ref) => {
                setViewerLoading(true);
                setViewerOpen(true);
                try {
                    const res = await fetch(`${API_BASE}/api/evidence/resolve?ref=${encodeURIComponent(ref)}`);
                    const json = await res.json();
                    if (res.ok && json.status === 'ready' && json.rows && json.rows[0]) {
                        setViewerData({
                            ref: json.rows[0].ref,
                            data: json.rows[0].data,
                            source: json.rows[0].source
                        });
                    } else {
                        setViewerData({ error: json.error || json.detail?.error || { message: 'Unknown error' } });
                    }
                } catch (e) {
                    setViewerData({ error: { message: e.message } });
                } finally {
                    setViewerLoading(false);
                }
            };

            const severityBadge = (severity) => {
                const colors = {
                    INFO: 'bg-slate-500/20 text-slate-400 border-slate-500/30',
                    WARN: 'bg-amber-500/20 text-amber-400 border-amber-500/30',
                    ERROR: 'bg-red-500/20 text-red-400 border-red-500/30',
                    CRITICAL: 'bg-red-600/30 text-red-300 border-red-600/50'
                };
                return `px-2 py-0.5 rounded text-xs font-bold border ${colors[severity] || colors.INFO}`;
            };

            // Empty State
            if (!data || data.error?.code === 'NO_INDEX_YET') {
                return (
                    <div className="bg-gradient-to-br from-teal-900/30 to-slate-900 border border-teal-700/50 rounded-2xl p-6">
                        <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2">
                            <span className="w-1 h-5 bg-teal-500 rounded"></span> Evidence Index
                            <span className="ml-2 px-2 py-0.5 rounded text-xs font-bold bg-slate-600/50 text-slate-400 border border-slate-600/30">NO INDEX</span>
                        </h3>
                        <div className="text-center py-6 text-slate-500 bg-slate-900/50 rounded-lg border border-dashed border-slate-700">
                            <div className="text-3xl mb-2">üìö</div>
                            <div className="font-semibold">No Evidence Index Yet</div>
                            <div className="text-sm mt-1">Ïù∏Îç±Ïä§Í∞Ä ÏïÑÏßÅ ÏÉùÏÑ±ÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.</div>
                        </div>
                        <button
                            onClick={handleRegenerate}
                            disabled={isRegenerating}
                            className="mt-4 w-full py-2 rounded-lg font-bold text-white bg-teal-600 hover:bg-teal-500 disabled:bg-slate-700 disabled:text-slate-500 transition"
                        >
                            {isRegenerating ? 'ÏÉùÏÑ± Ï§ë...' : 'üîÑ Regenerate Index'}
                        </button>
                    </div>
                );
            }

            const rows = data.rows || [];

            return (
                <div className="bg-gradient-to-br from-teal-900/30 to-slate-900 border border-teal-700/50 rounded-2xl p-6">
                    <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2">
                        <span className="w-1 h-5 bg-teal-500 rounded"></span> Evidence Index
                        <span className="ml-2 px-2 py-0.5 rounded text-xs font-bold bg-teal-500/20 text-teal-400 border border-teal-500/30">
                            {data.row_count || 0} items
                        </span>
                        <span className="text-xs font-mono text-slate-500 ml-auto">{data.asof?.slice(0, 16)}</span>
                    </h3>

                    {/* Evidence List */}
                    <div className="space-y-2 max-h-64 overflow-y-auto">
                        {rows.slice(0, 10).map((item, idx) => (
                            <div
                                key={idx}
                                onClick={() => handleViewEvidence(item.ref)}
                                className="flex items-center gap-3 p-3 bg-slate-800/50 rounded-lg border border-slate-700/30 cursor-pointer hover:bg-slate-700/50 transition"
                            >
                                <span className={severityBadge(item.severity)}>{item.severity}</span>
                                <div className="flex-1 min-w-0">
                                    <div className="text-sm text-white font-medium truncate">{item.title}</div>
                                    <div className="text-xs text-slate-500 truncate">{item.kind}</div>
                                </div>
                                <div className="text-xs text-slate-500">{item.created_at?.slice(0, 16)}</div>
                            </div>
                        ))}
                    </div>

                    {/* Regenerate Button */}
                    <button
                        onClick={handleRegenerate}
                        disabled={isRegenerating}
                        className="mt-4 w-full py-2 rounded-lg font-bold text-white bg-teal-600 hover:bg-teal-500 disabled:bg-slate-700 disabled:text-slate-500 transition"
                    >
                        {isRegenerating ? 'ÏÉùÏÑ± Ï§ë...' : 'üîÑ Regenerate Index'}
                    </button>

                    {/* Evidence Viewer Modal */}
                    {viewerOpen && (
                        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50" onClick={() => setViewerOpen(false)}>
                            <div className="bg-slate-900 border border-slate-700 rounded-2xl p-6 w-full max-w-3xl max-h-[80vh] overflow-hidden flex flex-col" onClick={e => e.stopPropagation()}>
                                <div className="flex items-center justify-between mb-4">
                                    <h4 className="text-lg font-bold text-white flex items-center gap-2">
                                        <span className="w-1 h-5 bg-teal-500 rounded"></span>
                                        Evidence Viewer
                                        <span className="text-xs text-slate-500 font-mono ml-2 truncate max-w-xs">{viewerData?.ref || ''}</span>
                                    </h4>
                                    <button onClick={() => setViewerOpen(false)} className="px-3 py-1 bg-red-900/50 hover:bg-red-800 text-red-300 rounded text-xs transition">
                                        ‚úï Close
                                    </button>
                                </div>
                                <div className="flex-1 overflow-auto bg-black rounded-lg border border-slate-800">
                                    {viewerLoading ? (
                                        <div className="p-8 text-center text-cyan-400 animate-pulse">Loading...</div>
                                    ) : viewerData?.error ? (
                                        <div className="p-8 text-center text-red-400">{viewerData.error.message || JSON.stringify(viewerData.error)}</div>
                                    ) : (
                                        <pre className="p-4 text-xs font-mono text-emerald-400 whitespace-pre-wrap">
                                            {JSON.stringify(viewerData?.data, null, 2)}
                                        </pre>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Phase C-P.33: Evidence Health Card
        function EvidenceHealthCard() {
            const [data, setData] = React.useState(null);
            const [isRegenerating, setIsRegenerating] = React.useState(false);

            React.useEffect(() => {
                fetchHealth();
            }, []);

            const fetchHealth = async () => {
                try {
                    const res = await fetch(`${API_BASE}/api/evidence/health/latest`);
                    if (res.ok) {
                        const json = await res.json();
                        setData(json);
                    }
                } catch (e) {
                    console.error("Evidence health fetch error:", e);
                }
            };

            const handleRegenerate = async () => {
                if (!confirm("Ï†ïÎßê Evidence HealthÎ•º Ïû¨ÏÉùÏÑ±ÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) return;
                setIsRegenerating(true);
                try {
                    const res = await fetch(`${API_BASE}/api/evidence/health/regenerate`, { method: 'POST' });
                    if (res.ok) fetchHealth();
                } catch (e) {
                    console.error("Regenerate error:", e);
                } finally {
                    setIsRegenerating(false);
                }
            };

            const decisionBadge = (decision) => {
                const colors = {
                    PASS: 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30',
                    WARN: 'bg-amber-500/20 text-amber-400 border-amber-500/30',
                    FAIL: 'bg-red-500/20 text-red-400 border-red-500/30',
                    UNKNOWN: 'bg-slate-500/20 text-slate-400 border-slate-500/30'
                };
                return `px-2 py-0.5 rounded text-xs font-bold border ${colors[decision] || colors.UNKNOWN}`;
            };

            // Empty State
            if (!data || data.error?.code === 'NO_REPORT_YET') {
                return (
                    <div className="bg-gradient-to-br from-violet-900/30 to-slate-900 border border-violet-700/50 rounded-2xl p-6">
                        <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2">
                            <span className="w-1 h-5 bg-violet-500 rounded"></span> Evidence Health
                            <span className="ml-2 px-2 py-0.5 rounded text-xs font-bold bg-slate-600/50 text-slate-400 border border-slate-600/30">NO REPORT</span>
                        </h3>
                        <div className="text-center py-4 text-slate-500">
                            <div className="text-2xl mb-2">üîç</div>
                            <div className="font-semibold">No Health Report Yet</div>
                        </div>
                        <button onClick={handleRegenerate} disabled={isRegenerating}
                            className="mt-3 w-full py-2 rounded-lg font-bold text-white bg-violet-600 hover:bg-violet-500 disabled:bg-slate-700 disabled:text-slate-500 transition">
                            {isRegenerating ? 'ÏÉùÏÑ± Ï§ë...' : 'üîÑ Regenerate'}
                        </button>
                    </div>
                );
            }

            const summary = data.summary || {};
            const checks = data.checks || [];

            return (
                <div className="bg-gradient-to-br from-violet-900/30 to-slate-900 border border-violet-700/50 rounded-2xl p-6">
                    <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2">
                        <span className="w-1 h-5 bg-violet-500 rounded"></span> Evidence Health
                        <span className={decisionBadge(summary.decision)}>{summary.decision}</span>
                        <span className="text-xs font-mono text-slate-500 ml-auto">{data.asof?.slice(0, 16)}</span>
                    </h3>
                    <div className="flex gap-4 mb-4">
                        <div className="flex-1 bg-emerald-900/30 rounded-lg p-3 text-center border border-emerald-700/30">
                            <div className="text-2xl font-bold text-emerald-400">{summary.pass}</div>
                            <div className="text-xs text-emerald-500">PASS</div>
                        </div>
                        <div className="flex-1 bg-amber-900/30 rounded-lg p-3 text-center border border-amber-700/30">
                            <div className="text-2xl font-bold text-amber-400">{summary.warn}</div>
                            <div className="text-xs text-amber-500">WARN</div>
                        </div>
                        <div className="flex-1 bg-red-900/30 rounded-lg p-3 text-center border border-red-700/30">
                            <div className="text-2xl font-bold text-red-400">{summary.fail}</div>
                            <div className="text-xs text-red-500">FAIL</div>
                        </div>
                    </div>
                    {data.top_fail_reasons?.length > 0 && (
                        <div className="text-xs text-slate-400 mb-3">
                            <span className="font-bold">Top Failures:</span>
                            {data.top_fail_reasons.slice(0, 3).map((fr, i) => (
                                <span key={i} className="ml-2 px-2 py-0.5 bg-red-900/30 rounded text-red-400">{fr.reason}: {fr.count}</span>
                            ))}
                        </div>
                    )}
                    <button onClick={handleRegenerate} disabled={isRegenerating}
                        className="w-full py-2 rounded-lg font-bold text-white bg-violet-600 hover:bg-violet-500 disabled:bg-slate-700 disabled:text-slate-500 transition">
                        {isRegenerating ? 'ÏÉùÏÑ± Ï§ë...' : 'üîÑ Regenerate'}
                    </button>
                </div>
            );
        }

        function TicketsView({ data, gateMode, opsData, pushDeliveryData }) {
            if (!data || data.status === 'not_ready') {
                return (
                    <div className="flex flex-col items-center justify-center py-20 border border-dashed border-slate-700 rounded-lg opacity-70">
                        <div className="text-4xl mb-4">üé´</div>
                        <h3 className="text-xl font-bold text-slate-400">Ìã∞Ïºì Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå</h3>
                        <p className="text-sm text-slate-500 mt-2">ÏïÑÏßÅ ÏÉùÏÑ±Îêú Ìã∞ÏºìÏù¥ ÏóÜÏäµÎãàÎã§.</p>
                    </div>
                );
            }

            const statusBadge = (status) => {
                const colors = {
                    'OPEN': 'bg-slate-500/20 text-slate-400 border-slate-500/30',
                    'IN_PROGRESS': 'bg-blue-500/20 text-blue-400 border-blue-500/30',
                    'DONE': 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30',
                    'FAILED': 'bg-red-500/20 text-red-400 border-red-500/30'
                };
                return `px-2 py-0.5 rounded text-xs font-bold border ${colors[status] || colors['OPEN']}`;
            };

            const formatTime = (isoStr) => {
                if (!isoStr) return '-';
                const d = new Date(isoStr);
                return d.toLocaleString('ko-KR', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
            };

            const rows = data.rows || [];

            const gateBadgeColor = gateMode === 'DRY_RUN' ? 'bg-amber-500/20 text-amber-400 border-amber-500/30' :
                gateMode === 'REAL_ENABLED' ? 'bg-red-500/20 text-red-400 border-red-500/30' :
                    'bg-cyan-500/20 text-cyan-400 border-cyan-500/30';

            return (
                <div className="space-y-6">
                    {/* Ops Report Card (C-P.13) */}
                    {opsData && (
                        <div className="bg-gradient-to-br from-slate-800 to-slate-900 border border-slate-700 rounded-2xl p-6">
                            <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2">
                                <span className="w-1 h-5 bg-emerald-500 rounded"></span> Daily Ops Summary
                                <span className="text-xs font-mono text-slate-500 ml-auto">{opsData.period}</span>
                            </h3>
                            <div className="grid grid-cols-4 gap-4 mb-4">
                                <div className="bg-slate-900/50 p-3 rounded-lg text-center">
                                    <div className="text-xs text-slate-500 mb-1">Total</div>
                                    <div className="text-2xl font-mono font-bold text-white">{opsData.summary?.tickets_total || 0}</div>
                                </div>
                                <div className="bg-emerald-900/30 p-3 rounded-lg text-center border border-emerald-900/50">
                                    <div className="text-xs text-emerald-400 mb-1">DONE</div>
                                    <div className="text-2xl font-mono font-bold text-emerald-400">{opsData.summary?.done || 0}</div>
                                </div>
                                <div className="bg-red-900/30 p-3 rounded-lg text-center border border-red-900/50">
                                    <div className="text-xs text-red-400 mb-1">FAILED</div>
                                    <div className="text-2xl font-mono font-bold text-red-400">{opsData.summary?.failed || 0}</div>
                                </div>
                                <div className="bg-amber-900/30 p-3 rounded-lg text-center border border-amber-900/50">
                                    <div className="text-xs text-amber-400 mb-1">BLOCKED</div>
                                    <div className="text-2xl font-mono font-bold text-amber-400">{opsData.summary?.blocked || 0}</div>
                                </div>
                            </div>
                            {opsData.blocked_reasons_top && opsData.blocked_reasons_top.length > 0 && (
                                <div className="bg-slate-900/50 p-3 rounded-lg">
                                    <div className="text-xs text-slate-500 mb-2">Top Blocked Reasons</div>
                                    <div className="space-y-1">
                                        {opsData.blocked_reasons_top.map((r, i) => (
                                            <div key={i} className="flex justify-between text-xs">
                                                <span className="text-amber-300 truncate">{r.reason}</span>
                                                <span className="text-slate-400 font-mono">{r.count}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                            {/* C-P.14: Last DONE/FAILED/BLOCKED triplet */}
                            <div className="grid grid-cols-3 gap-2 mt-4 text-xs">
                                <div className="bg-emerald-900/20 p-2 rounded border border-emerald-900/30">
                                    <div className="text-emerald-400 font-bold mb-1">Last DONE</div>
                                    {opsData.last_done ? (
                                        <div className="text-emerald-300 font-mono truncate">{opsData.last_done.request_type}</div>
                                    ) : (
                                        <div className="text-slate-500">-</div>
                                    )}
                                </div>
                                <div className="bg-red-900/20 p-2 rounded border border-red-900/30">
                                    <div className="text-red-400 font-bold mb-1">Last FAILED</div>
                                    {opsData.last_failed ? (
                                        <div className="text-red-300 font-mono truncate">{opsData.last_failed.reason}</div>
                                    ) : (
                                        <div className="text-slate-500">-</div>
                                    )}
                                </div>
                                <div className="bg-amber-900/20 p-2 rounded border border-amber-900/30">
                                    <div className="text-amber-400 font-bold mb-1">Last BLOCKED</div>
                                    {opsData.last_blocked ? (
                                        <div className="text-amber-300 font-mono truncate">{opsData.last_blocked.reason}</div>
                                    ) : (
                                        <div className="text-slate-500">-</div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Push Delivery Card (C-P.18) */}
                    {pushDeliveryData && (
                        <div className="bg-gradient-to-br from-indigo-900/30 to-slate-900 border border-indigo-700/50 rounded-2xl p-6">
                            <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2">
                                <span className="w-1 h-5 bg-indigo-500 rounded"></span> Push Delivery
                                <span className={`ml-2 px-2 py-0.5 rounded text-xs font-bold ${pushDeliveryData.gate_mode === 'REAL_ENABLED'
                                    ? 'bg-red-500/20 text-red-400 border border-red-500/30'
                                    : 'bg-cyan-500/20 text-cyan-400 border border-cyan-500/30'
                                    }`}>{pushDeliveryData.gate_mode}</span>
                                <span className="text-xs font-mono text-slate-500 ml-auto">{pushDeliveryData.asof?.slice(0, 16)}</span>
                            </h3>
                            <div className="grid grid-cols-4 gap-4">
                                <div className="text-center p-3 bg-slate-800/50 rounded-lg">
                                    <div className="text-2xl font-bold text-white">{pushDeliveryData.summary?.total_messages || 0}</div>
                                    <div className="text-xs text-slate-400">Total</div>
                                </div>
                                <div className="text-center p-3 bg-cyan-900/30 rounded-lg border border-cyan-800/50">
                                    <div className="text-2xl font-bold text-cyan-400">{pushDeliveryData.summary?.console || 0}</div>
                                    <div className="text-xs text-cyan-300">Console</div>
                                </div>
                                <div className="text-center p-3 bg-emerald-900/30 rounded-lg border border-emerald-800/50">
                                    <div className="text-2xl font-bold text-emerald-400">{pushDeliveryData.summary?.external || 0}</div>
                                    <div className="text-xs text-emerald-300">External</div>
                                </div>
                                <div className="text-center p-3 bg-amber-900/30 rounded-lg border border-amber-800/50">
                                    <div className="text-2xl font-bold text-amber-400">{pushDeliveryData.summary?.skipped || 0}</div>
                                    <div className="text-xs text-amber-300">Skipped</div>
                                </div>
                            </div>
                            {pushDeliveryData.decisions && pushDeliveryData.decisions.length > 0 && (
                                <div className="mt-4 text-xs text-slate-400">
                                    <span className="font-mono bg-slate-700/50 px-2 py-1 rounded">
                                        {pushDeliveryData.decisions[0].reason_code}
                                    </span>
                                </div>
                            )}
                        </div>
                    )}

                    {/* Ops Run Receipt Card (C-P.28) */}
                    <OpsReceiptCard />

                    {/* Evidence Index Card (C-P.31) */}
                    <EvidenceCard />

                    {/* Evidence Health Card (C-P.33) */}
                    <EvidenceHealthCard />

                    {/* Ticket Status Board */}
                    <div className="bg-slate-800 border border-slate-700 rounded-2xl p-6">
                        <h2 className="text-lg font-bold text-white mb-4 flex items-center gap-2">
                            <span className="w-1 h-5 bg-cyan-500 rounded"></span> Ticket Status Board
                            <span className="text-sm font-normal text-slate-500">({rows.length} tickets)</span>
                            <span className={`ml-auto px-2 py-0.5 rounded text-xs font-bold border ${gateBadgeColor}`}>
                                Gate: {gateMode || 'MOCK_ONLY'}
                            </span>
                        </h2>
                        {rows.length === 0 ? (
                            <div className="text-center py-8 text-slate-500 bg-slate-900/50 rounded-lg border border-dashed border-slate-700">
                                No tickets yet
                            </div>
                        ) : (
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm text-left text-slate-400">
                                    <thead className="text-slate-500 uppercase bg-slate-900/50">
                                        <tr>
                                            <th className="px-4 py-3 rounded-l-lg">Requested At</th>
                                            <th className="px-4 py-3">Type</th>
                                            <th className="px-4 py-3">Trace ID</th>
                                            <th className="px-4 py-3">Status</th>
                                            <th className="px-4 py-3 rounded-r-lg">Message</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {rows.map((t, idx) => (
                                            <tr key={t.request_id || idx} className="border-b border-slate-700 hover:bg-slate-700/30 transition-colors">
                                                <td className="px-4 py-3 font-mono text-xs">{formatTime(t.requested_at)}</td>
                                                <td className="px-4 py-3">{t.request_type}</td>
                                                <td className="px-4 py-3 font-mono text-xs">{t.trace_id || '-'}</td>
                                                <td className="px-4 py-3">
                                                    <span className={statusBadge(t.current_status)}>{t.current_status}</span>
                                                </td>
                                                <td className="px-4 py-3 text-slate-500 truncate max-w-[200px]">{t.last_message || '-'}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        function App() {
            const [status, setStatus] = useState(null);
            const [portfolio, setPortfolio] = useState(null);
            const [signals, setSignals] = useState(null);
            const [history, setHistory] = useState([]);
            const [rawLogs, setRawLogs] = useState(null);
            const [validationData, setValidationData] = useState(null);

            // Contract 5 States
            const [humanReport, setHumanReport] = useState(null);
            const [dailyRows, setDailyRows] = useState(null);

            const [gatekeeperData, setGatekeeperData] = useState(null);
            const [ticketsData, setTicketsData] = useState(null);
            const [gateMode, setGateMode] = useState("MOCK_ONLY");
            const [opsData, setOpsData] = useState(null);  // C-P.13
            const [pushDeliveryData, setPushDeliveryData] = useState(null);  // C-P.18
            const [opsReceiptData, setOpsReceiptData] = useState(null);  // C-P.28
            const [opsRunStatus, setOpsRunStatus] = useState(null);  // C-P.28 Run Status
            const [activeTab, setActiveTab] = useState("dashboard");

            // Integrity Check Logic
            const integrityIssues = useMemo(() => {
                const issues = [];

                // Contract 5: Human Report Integrity
                if (humanReport && humanReport.integrity_summary) {
                    const crit = humanReport.integrity_summary.critical_total;
                    if (crit > 0) {
                        issues.push({
                            type: 'error',
                            message: `CRITICAL Integrity Issues: ${crit} items (See Diagnosis)`
                        });
                    }
                }

                // IC1: Diagnosis Validation Mismatch (LEGACY PAUSED)
                // Note: Human Report is aggregate, need new logic for yearly mismatch if required.
                /*
                ['2024', '2025'].forEach(y => {
                        // ... legacy logic removed for stability
                    });
                    */

                if (gatekeeperData && gatekeeperData.integrity) {
                    // IC2: Gatekeeper Baseline Mismatch
                    if (gatekeeperData.integrity.config_missing || gatekeeperData.integrity.unit_mismatch) {
                        issues.push({
                            id: 'IC2_GATEKEEPER_BASELINE_MISMATCH',
                            when: 'Gatekeeper',
                            message: `Gatekeeper Í∏∞Ï§ÄÍ∞í Î¨¥Í≤∞ÏÑ± Ïò§Î•ò: ${gatekeeperData.integrity.notes || "ÏÑ§Ï†ï ÎàÑÎùΩ/Îã®ÏúÑ ÌòºÏÑ†"}`
                        });
                    }
                }
                return issues;
            }, [validationData, humanReport, gatekeeperData]);

            useEffect(() => {
                if (status) {
                    const isCrash = status.badge === 'FAIL';
                    const isDamaged = status.read_quality !== 'perfect';
                    const hasErrors = (status.evidence && status.evidence.error_count) ? status.evidence.error_count > 0 : false;

                    if (isCrash || isDamaged || hasErrors) {
                        if (activeTab === 'dashboard') {
                            setActiveTab('logs');
                        }
                    }
                }
            }, [status]);

            const fetchData = async () => {
                try {
                    const sRes = await fetch(`${API_BASE}/api/status`);
                    const sData = await sRes.json();

                    if (sData.schema_version !== "UI-1.0") {
                        console.warn(`Schema Mismatch: Expected UI-1.0, got ${sData.schema_version}`);
                        sData.message = `[Schema Mismatch] ${sData.message}`;
                        if (!sData.evidence) sData.evidence = { error_count: 1 };
                        else sData.evidence.error_count += 1;
                    }

                    setStatus(sData);
                    if (sData.log_file) fetchLogs(sData.log_file);

                    const pRes = await fetch(`${API_BASE}/api/portfolio`);
                    setPortfolio(await pRes.json());

                    const sigRes = await fetch(`${API_BASE}/api/signals`);
                    setSignals(await sigRes.json());

                    const hRes = await fetch(`${API_BASE}/api/history`);
                    setHistory(await hRes.json());


                    // Contract C-R.6: Fetch Human Report and Daily Rows
                    const hReportRes = await fetch(`${API_BASE}/api/report/human`);
                    if (hReportRes.ok) {
                        const hReport = await hReportRes.json();
                        setHumanReport(hReport);
                    }

                    const reconDailyRes = await fetch(`${API_BASE}/api/recon/daily`);
                    if (reconDailyRes.ok) {
                        const rData = await reconDailyRes.json();
                        // Normalize Envelope
                        const rows = (rData.rows) ? rData.rows : (Array.isArray(rData) ? rData : []);
                        setDailyRows(rows);
                        console.log(`Recon Daily Loaded: ${rows.length} rows`);
                    }

                    // Contract 2: Gatekeeper V3 Consumption
                    const gRes = await fetch(`${API_BASE}/api/gatekeeper/v3`);
                    const gData = await gRes.json();
                    if (gData.status !== "not_ready") setGatekeeperData(gData);

                    // Legacy Validation (Optional but keeping for now)
                    const vRes = await fetch(`${API_BASE}/api/validation`);
                    setValidationData(await vRes.json());

                    // Phase C-P.2: Tickets Board
                    const tRes = await fetch(`${API_BASE}/api/tickets/latest`);
                    if (tRes.ok) {
                        const tData = await tRes.json();
                        setTicketsData(tData);
                    }

                    // Phase C-P.4: Execution Gate
                    const gateRes = await fetch(`${API_BASE}/api/execution_gate`);
                    if (gateRes.ok) {
                        const gateData = await gateRes.json();
                        setGateMode(gateData.data?.mode || "MOCK_ONLY");
                    }

                    // Phase C-P.13: Daily Ops Report
                    const opsRes = await fetch(`${API_BASE}/api/ops/daily`);
                    if (opsRes.ok) {
                        const opsApiData = await opsRes.json();
                        if (opsApiData.rows && opsApiData.rows.length > 0) {
                            setOpsData(opsApiData.rows[0]);
                        }
                    }

                    // Phase C-P.18: Push Delivery
                    const pushDelRes = await fetch(`${API_BASE}/api/push/delivery/latest`);
                    if (pushDelRes.ok) {
                        const pushDelData = await pushDelRes.json();
                        if (pushDelData.data) {
                            setPushDeliveryData(pushDelData.data);
                        }
                    }

                    // Phase C-P.28: Ops Scheduler Receipt
                    const opsReceiptRes = await fetch(`${API_BASE}/api/ops/scheduler/latest`);
                    if (opsReceiptRes.ok) {
                        const opsReceiptData = await opsReceiptRes.json();
                        setOpsReceiptData(opsReceiptData);
                    }

                } catch (e) {
                    console.error("Fetch Error", e);
                    setStatus({ badge: "ERROR", message: "Backend Disconnected", read_quality: "failed" });
                }
            };

            const fetchLogs = async (filename) => {
                try {
                    const res = await fetch(`${API_BASE}/api/raw?filename=${filename}`);
                    if (!res.ok) { setRawLogs(""); return; }
                    const data = await res.json();
                    setRawLogs(data.content);
                } catch (e) { setRawLogs(""); }
            }

            useEffect(() => { fetchData(); }, []);

            return (
                <div className="min-h-screen bg-slate-900 pb-20">
                    {/* Header */}
                    <header className="sticky top-0 z-50 bg-slate-900/80 backdrop-blur border-b border-slate-800">
                        <div className="container mx-auto px-4 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-4">
                                <div className="w-3 h-8 bg-cyan-500 rounded-sm"></div>
                                <div>
                                    <h1 className="text-xl font-bold text-white tracking-widest">KRX ALERTOR</h1>
                                    <p className="text-[10px] text-cyan-400 font-mono tracking-[0.2em] uppercase">Phase 14.4 Observer</p>
                                </div>
                            </div>
                            <div className="flex items-center gap-4">
                                <Badge status={status} />
                                <button onClick={() => window.location.reload()} className="p-2 hover:bg-slate-800 rounded transition-colors" title="Refresh">
                                    <svg className="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                                </button>
                            </div>
                        </div>
                    </header>

                    <div className="container mx-auto px-4 py-8 max-w-5xl">

                        {/* Integrity Banner */}
                        <IntegrityBanner issues={integrityIssues} />

                        {/* Tab Nav */}
                        <div className="flex gap-1 bg-slate-800 p-1 rounded-lg mb-8 mx-auto max-w-4xl">
                            {['dashboard', 'signals', 'reco', 'validation', 'diagnosis', 'gatekeeper', 'tickets', 'logs'].map(tab => (
                                <button
                                    key={tab}
                                    onClick={() => setActiveTab(tab)}
                                    className={`flex-1 py-1.5 text-sm font-medium rounded-md transition-all ${activeTab === tab ? 'bg-slate-700 text-white shadow' : 'text-slate-400 hover:text-slate-200 hover:bg-slate-700/50'} capitalize`}
                                >
                                    {tab}
                                </button>
                            ))}
                        </div>

                        {/* Content */}
                        <main className="animate-fade-in-up">
                            {activeTab === 'dashboard' && (
                                <div className="space-y-8">
                                    {/* Summary Cards */}
                                    <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
                                        <StatCard label="Total Equity" value={portfolio ? formatMoney(portfolio.total_equity) : '-'} subValue="Waiting" trend="neutral" />
                                        <StatCard label="Cash Available" value={portfolio ? formatMoney(portfolio.cash) : '-'} subValue={`${portfolio ? ((portfolio.cash / portfolio.total_equity) * 100).toFixed(1) : 0}%`} trend="neutral" />
                                        <StatCard label="Daily PnL" value={history.length > 0 ? formatMoney(history[history.length - 1].date_pnl) : '-'} subValue={history.length > 0 ? `${history[history.length - 1].date_return_pct}%` : '-'} trend={history.length > 0 && history[history.length - 1].date_pnl > 0 ? 'up' : 'down'} />
                                        <StatCard label="Active Positions" value={portfolio && portfolio.holdings ? Object.keys(portfolio.holdings).length : 0} />
                                    </div>

                                    {/* Holdings Table */}
                                    <div className="bg-slate-800 border border-slate-700 rounded-2xl p-6">
                                        <h2 className="text-lg font-bold text-white mb-4 flex items-center gap-2">
                                            <span className="w-1 h-5 bg-cyan-500 rounded"></span> Current Holdings
                                        </h2>
                                        {!portfolio || !portfolio.holdings || Object.keys(portfolio.holdings).length === 0 ? (
                                            <div className="text-center py-12 text-slate-500 bg-slate-900/50 rounded-lg border border-dashed border-slate-700">
                                                No active positions (100% Cash)
                                            </div>
                                        ) : (
                                            <div className="overflow-x-auto">
                                                <table className="w-full text-sm text-left text-slate-400">
                                                    <thead className="text-slate-500 uppercase bg-slate-900/50">
                                                        <tr>
                                                            <th className="px-4 py-3 rounded-l-lg">Code</th>
                                                            <th className="px-4 py-3">Qty</th>
                                                            <th className="px-4 py-3">Avg Price</th>
                                                            <th className="px-4 py-3">Mkt Value</th>
                                                            <th className="px-4 py-3 text-right rounded-r-lg">P&L</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {Object.entries(portfolio.holdings).map(([code, h]) => (
                                                            <tr key={code} className="border-b border-slate-700 hover:bg-slate-700/30 transition-colors">
                                                                <td className="px-4 py-3 font-mono text-white font-bold">{code}</td>
                                                                <td className="px-4 py-3">{h.qty}</td>
                                                                <td className="px-4 py-3">{formatAmount(h.avg_price)}</td>
                                                                <td className="px-4 py-3 text-white">{formatMoney(h.market_value)}</td>
                                                                <td className={`px-4 py-3 text-right font-bold ${h.pnl >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                                                                    {h.pnl_pct}% ({formatAmount(h.pnl)})
                                                                </td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}

                            {activeTab === 'signals' && (
                                <SignalsList signals={signals ? signals.signals : []} />
                            )}

                            {activeTab === 'reco' && (
                                <RecoCard />
                            )}

                            {activeTab === 'validation' && (
                                <ValidationView data={validationData} />
                            )}

                            {activeTab === 'diagnosis' && (
                                <DiagnosisView
                                    humanReport={humanReport}
                                    dailyRows={dailyRows}
                                />
                            )}

                            {activeTab === 'gatekeeper' && (
                                <GatekeeperView data={gatekeeperData} />
                            )}

                            {activeTab === 'tickets' && (
                                <TicketsView data={ticketsData} gateMode={gateMode} opsData={opsData} />
                            )}

                            {activeTab === 'logs' && (
                                <div className="space-y-2">
                                    <div className="bg-black border border-slate-800 rounded-t-lg p-2 flex items-center gap-2">
                                        <div className="flex gap-1.5 ml-2">
                                            <div className="w-2.5 h-2.5 rounded-full bg-red-500/50"></div>
                                            <div className="w-2.5 h-2.5 rounded-full bg-amber-500/50"></div>
                                            <div className="w-2.5 h-2.5 rounded-full bg-green-500/50"></div>
                                        </div>
                                        <div className="mx-auto text-xs text-slate-500 font-mono opacity-50">Terminal Output Helper</div>
                                    </div>
                                    <LogViewer logFile={status?.log_file} content={rawLogs} />
                                </div>
                            )}
                        </main>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>