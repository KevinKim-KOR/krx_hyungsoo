<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KRX Alertor Cockpit</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#1e293b', 900: '#0f172a' },
                        cyan: { 400: '#22d3ee', 500: '#06b6d4', 900: '#164e63' }
                    },
                    fontFamily: { mono: ['Consolas', 'Monaco', 'monospace'] }
                }
            }
        }
    </script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Recharts -->
    <script src="https://unpkg.com/recharts/umd/Recharts.js"></script>
</head>

<body class="bg-slate-900 text-slate-200 font-sans selection:bg-cyan-500 selection:text-white">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const { LineChart, Line, XAxis, YAxis, Tooltip, ResponsiveContainer } = Recharts;

        const API_BASE = "http://localhost:8000";

        // --- Utils ---
        const formatMoney = (n) => n?.toLocaleString('ko-KR') || '0';
        const formatDate = (d) => {
            if (!d) return '-';
            const s = String(d);
            return `${s.substring(0, 4)}-${s.substring(4, 6)}-${s.substring(6, 8)}`;
        };

        // --- Components ---

        function Badge({ status }) {
            // Rule 1: Badge & Quality 2-Axis Logic
            let color = "bg-slate-500";
            let text = "UNKNOWN";
            let pulse = false;

            if (status) {
                const { badge, read_quality, evidence } = status;

                if (badge === "FAIL" || badge === "ERROR") {
                    color = "bg-red-600 shadow-[0_0_15px_rgba(220,38,38,0.7)]";
                    text = "SYSTEM FAIL";
                    pulse = true;
                } else if (badge === "OK" || badge === "SKIP") {
                    if (read_quality !== "perfect") {
                        color = "bg-yellow-500 text-black shadow-[0_0_15px_rgba(234,179,8,0.6)]";
                        text = "OK (LOG DAMAGED)";
                        pulse = true;
                    } else if (evidence?.error_count > 0) {
                        color = "bg-orange-500 text-white";
                        text = "OK (ERRORS FOUND)";
                    } else {
                        color = "bg-emerald-500 shadow-[0_0_10px_rgba(16,185,129,0.5)]";
                        text = "OPERATIONAL";
                    }
                }
            }

            return (
                <div className={`flex items-center gap-3 px-4 py-2 rounded-full font-bold text-sm tracking-wider transition-all duration-300 ${color} ${pulse ? 'animate-pulse' : ''}`}>
                    <div className={`w-2 h-2 rounded-full bg-white ${pulse ? 'animate-ping' : ''}`}></div>
                    {text}
                </div>
            );
        }

        function SignalsTable({ signals }) {
            // Rule 2 & 5: Honest Empty States
            if (!signals) return <div className="p-8 text-center text-slate-500 font-mono">Loading Signals...</div>;

            if (signals.length === 0) {
                return (
                    <div className="flex flex-col items-center justify-center py-12 border border-dashed border-slate-700 rounded-lg opacity-70">
                        <div className="text-4xl mb-2">üí§</div>
                        <h3 className="text-xl font-bold text-slate-400">Ïò§Îäò Í±∞Îûò ÏóÜÏùå (No Action)</h3>
                        <p className="text-sm text-slate-500">ÏãúÏû• Í∞êÏãú Í≤∞Í≥º, ÏßÑÏûÖ/Ï≤≠ÏÇ∞ Ï°∞Í±¥Ïóê Î∂ÄÌï©ÌïòÎäî Ï¢ÖÎ™©Ïù¥ ÏóÜÏäµÎãàÎã§.</p>
                    </div>
                );
            }

            return (
                <div className="grid gap-3">
                    {signals.map((sig, idx) => (
                        <div key={idx} className="bg-slate-800 border border-slate-700 p-4 rounded-lg flex items-center justify-between hover:border-cyan-500/50 transition-colors">
                            <div className="flex items-center gap-4">
                                <span className={`px-3 py-1 text-xs font-bold rounded ${sig.signal_type === 'BUY' ? 'bg-red-500/20 text-red-400 border border-red-500/30' :
                                    sig.signal_type === 'SELL' ? 'bg-blue-500/20 text-blue-400 border border-blue-500/30' : 'bg-slate-700'
                                    }`}>
                                    {sig.signal_type}
                                </span>
                                <span className="font-mono text-lg font-bold text-white tracking-widest">{sig.code}</span>
                            </div>
                            <div className="text-right">
                                <div className="text-sm text-slate-300">{sig.reason}</div>
                                {sig.score && <div className="text-xs text-slate-500 font-mono">Score: {sig.score.toFixed(2)}</div>}
                            </div>
                        </div>
                    ))}
                </div>
            );
        }

        function LogViewer({ logFile, content }) {
            // Rule 5: Honest Empty States for Logs
            if (!logFile) return <div className="p-8 text-center text-slate-500">Î°úÍ∑∏ ÌååÏùº Í≤ΩÎ°ú Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.</div>
            if (content === null) return <div className="p-8 text-center text-cyan-400 animate-pulse">Connecting to Source...</div>
            if (content === "") return <div className="p-8 text-center text-red-400 border border-red-900 bg-red-900/10 rounded">Î°úÍ∑∏ ÌååÏùºÏùÑ ÏùΩÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. (File Not Found or Access Denied)</div>

            return (
                <div className="relative group">
                    <div className="absolute top-2 right-2 px-2 py-1 bg-slate-800 text-xs text-slate-500 rounded font-mono border border-slate-700">
                        {logFile}
                    </div>
                    <pre className="bg-black text-xs md:text-sm font-mono text-emerald-500 p-4 rounded-lg overflow-x-auto whitespace-pre-wrap max-h-[600px] border border-slate-800 shadow-inner custom-scrollbar">
                        {content}
                    </pre>
                </div>
            )
        }

        // --- Main App ---

        function App() {
            const [status, setStatus] = useState(null);
            const [portfolio, setPortfolio] = useState(null);
            const [signals, setSignals] = useState(null);
            const [history, setHistory] = useState([]);
            const [rawLogs, setRawLogs] = useState(null);
            const [activeTab, setActiveTab] = useState("dashboard");

            // Rule 3: Auto-Focus Logs on Failure
            useEffect(() => {
                if (status) {
                    const isCrash = status.badge === 'FAIL';
                    const isDamaged = status.read_quality !== 'perfect';
                    const hasErrors = (status.evidence?.error_count || 0) > 0;

                    if (isCrash || isDamaged || hasErrors) {
                        // Only switch if we haven't manually switched (simple logic: just switch once on load ideally, 
                        // but here we force it to ensure attention)
                        // To be user-friendly, maybe only switch if we are on dashboard.
                        if (activeTab === 'dashboard') {
                            setActiveTab('logs');
                        }
                    }
                }
            }, [status]);

            // Data Fetching
            const fetchData = async () => {
                try {
                    const sRes = await fetch(`${API_BASE}/api/status`);
                    const sData = await sRes.json();

                    // Rule 4: API Versioning Check (UI Constitution)
                    if (sData.schema_version !== "UI-1.0") {
                        console.warn(`Schema Mismatch: Expected UI-1.0, got ${sData.schema_version}`);
                        // Optionally set a flag or show a toast. For now, strict validation might mean treating it as UNKNOWN or Partial.
                        // However, to keep it operational, we will just warn in console unless it's critical.
                        // Let's make it visible in the badge logic if we wanted, but the requirement was "UIÍ∞Ä Ïù¥Î•º Í≤ÄÏ¶ùÌï¥Ïïº Ìï©ÎãàÎã§".
                        // Minimal implementation: if mismatch, append warning to message set below.
                        sData.message = `[Schema Mismatch] ${sData.message}`;
                        // Force a WARN state if mismatch
                        if (!sData.evidence) sData.evidence = { error_count: 1 };
                        else sData.evidence.error_count += 1;
                    }

                    setStatus(sData);
                    if (sData.log_file) fetchLogs(sData.log_file);

                    const pRes = await fetch(`${API_BASE}/api/portfolio`);
                    setPortfolio(await pRes.json());

                    const sigRes = await fetch(`${API_BASE}/api/signals`);
                    setSignals(await sigRes.json());

                    const hRes = await fetch(`${API_BASE}/api/history`);
                    setHistory(await hRes.json());

                } catch (e) {
                    console.error("Fetch Error", e);
                    // Minimal Fallback for total offline
                    setStatus({ badge: "ERROR", message: "Backend Disconnected", read_quality: "failed" });
                }
            };

            const fetchLogs = async (filename) => {
                try {
                    // Assuming filename is relative like 'logs/daily_...'
                    const res = await fetch(`${API_BASE}/api/raw?filename=${filename}`);
                    if (!res.ok) { setRawLogs(""); return; } // Empty string triggers error UI
                    const data = await res.json();
                    setRawLogs(data.content);
                } catch (e) { setRawLogs(""); }
            }

            useEffect(() => { fetchData(); }, []);

            // Calculated Values
            const recentHistory = useMemo(() => {
                if (!history.length) return [];
                return history.slice(-5); // Last 5 days for Context
            }, [history]);

            return (
                <div className="min-h-screen bg-slate-900 pb-20">
                    {/* Header */}
                    <header className="sticky top-0 z-50 bg-slate-900/80 backdrop-blur border-b border-slate-800">
                        <div className="container mx-auto px-4 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-4">
                                <div className="w-3 h-8 bg-cyan-500 rounded-sm"></div>
                                <div>
                                    <h1 className="text-xl font-bold text-white tracking-widest">KRX ALERTOR</h1>
                                    <p className="text-[10px] text-cyan-400 font-mono tracking-[0.2em] uppercase">Phase 14.4 Observer</p>
                                </div>
                            </div>
                            <div className="flex items-center gap-4">
                                <Badge status={status} />
                                <button onClick={() => window.location.reload()} className="p-2 hover:bg-slate-800 rounded transition-colors" title="Refresh">
                                    <svg className="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                                </button>
                            </div>
                        </div>
                    </header>

                    <div className="container mx-auto px-4 py-8 max-w-5xl">

                        {/* Tab Nav */}
                        <div className="flex gap-1 bg-slate-800 p-1 rounded-lg mb-8 mx-auto max-w-md">
                            {['dashboard', 'signals', 'logs'].map(tab => (
                                <button
                                    key={tab}
                                    onClick={() => setActiveTab(tab)}
                                    className={`flex-1 py-1.5 text-sm font-medium rounded-md transition-all ${activeTab === tab ? 'bg-slate-700 text-white shadow' : 'text-slate-400 hover:text-slate-200 hover:bg-slate-700/50'
                                        } capitalize`}
                                >
                                    {tab}
                                </button>
                            ))}
                        </div>

                        {/* Content */}
                        <main className="animate-fade-in-up">
                            {activeTab === 'dashboard' && (
                                <div className="space-y-6">
                                    {/* Asset Card */}
                                    <section className="bg-slate-800 border border-slate-700 rounded-2xl p-6 md:p-8">
                                        <div className="flex justify-between items-end mb-6">
                                            <div>
                                                <h2 className="text-slate-400 text-sm font-bold uppercase tracking-wider mb-1">Total Equity</h2>
                                                <div className="text-4xl md:text-5xl font-bold text-white font-mono tracking-tighter">
                                                    {portfolio ? formatMoney(portfolio.total_equity) : '---'}
                                                    <span className="text-lg text-slate-500 font-sans ml-2">KRW</span>
                                                </div>
                                            </div>
                                            <div className="text-right hidden md:block">
                                                <div className="text-slate-400 text-sm">Cash Available</div>
                                                <div className="text-xl font-bold text-cyan-400 font-mono">{portfolio ? formatMoney(portfolio.cash) : '-'}</div>
                                            </div>
                                        </div>

                                        {/* Chart (Context) */}
                                        <div className="h-48 w-full bg-slate-900/50 rounded-lg border border-slate-800 p-2">
                                            {history.length > 0 ? (
                                                <ResponsiveContainer width="100%" height="100%">
                                                    <LineChart data={recentHistory}>
                                                        <Tooltip
                                                            contentStyle={{ backgroundColor: '#0f172a', border: '1px solid #334155' }}
                                                            itemStyle={{ color: '#22d3ee' }}
                                                        />
                                                        <XAxis dataKey="date" stroke="#475569" fontSize={10} tickLine={false} axisLine={false} />
                                                        <Line type="monotone" dataKey="equity" stroke="#22d3ee" strokeWidth={2} dot={{ fill: '#0f172a', stroke: '#22d3ee', r: 3 }} activeDot={{ r: 5, fill: '#22d3ee' }} />
                                                    </LineChart>
                                                </ResponsiveContainer>
                                            ) : (
                                                <div className="flex items-center justify-center h-full text-xs text-slate-600">History Data Not Available</div>
                                            )}
                                        </div>
                                    </section>

                                    {/* Portfolio Snippet */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div className="bg-slate-800 border border-slate-700 rounded-2xl p-6">
                                            <h3 className="text-slate-300 font-bold mb-4 flex items-center gap-2">
                                                <span className="w-2 h-2 rounded bg-cyan-500"></span> Holdings
                                            </h3>
                                            <div className="space-y-3">
                                                {portfolio?.positions && Object.keys(portfolio.positions).length > 0 ? (
                                                    Object.entries(portfolio.positions).map(([code, pos]) => (
                                                        <div key={code} className="flex justify-between items-center text-sm p-3 bg-slate-900/50 rounded hover:bg-slate-900 transition-colors cursor-default">
                                                            <span className="font-mono text-cyan-300 font-bold">{code}</span>
                                                            <div className="text-right">
                                                                <div className="text-white font-mono">{pos.qty} <span className="text-slate-500 text-xs">QTY</span></div>
                                                                <div className="text-slate-500 text-xs">@{formatMoney(pos.avg_price)}</div>
                                                            </div>
                                                        </div>
                                                    ))
                                                ) : (
                                                    <div className="text-slate-500 text-sm py-8 text-center bg-slate-900/30 rounded border border-dashed border-slate-800">
                                                        Î≥¥Ïú† Ï¢ÖÎ™©Ïù¥ ÏóÜÏäµÎãàÎã§ (Cash 100%)
                                                    </div>
                                                )}
                                            </div>
                                        </div>

                                        <div className="bg-slate-800 border border-slate-700 rounded-2xl p-6">
                                            <h3 className="text-slate-300 font-bold mb-4 flex items-center gap-2">
                                                <span className="w-2 h-2 rounded bg-purple-500"></span> System Evidence
                                            </h3>
                                            <div className="space-y-4 text-sm mt-6">
                                                <div className="flex justify-between pb-2 border-b border-slate-700">
                                                    <span className="text-slate-400">Date</span>
                                                    <span className="text-white font-mono">{status ? formatDate(status.date) : '-'}</span>
                                                </div>
                                                <div className="flex justify-between pb-2 border-b border-slate-700">
                                                    <span className="text-slate-400">Read Quality</span>
                                                    <span className={`font-mono ${status?.read_quality === 'perfect' ? 'text-emerald-400' : 'text-yellow-400'}`}>
                                                        {status?.read_quality?.toUpperCase() || '-'}
                                                    </span>
                                                </div>
                                                <div className="flex justify-between pb-2 border-b border-slate-700">
                                                    <span className="text-slate-400">Last Status</span>
                                                    <span className="text-white text-right max-w-[150px] truncate">{status?.message || '-'}</span>
                                                </div>
                                                <div className="flex justify-between">
                                                    <span className="text-slate-400">Log File</span>
                                                    <span className="text-slate-500 font-mono text-xs truncate max-w-[150px]" title={status?.log_file}>{status?.log_file || '-'}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'signals' && (
                                <div className="bg-slate-800 border border-slate-700 rounded-2xl p-6">
                                    <div className="flex justify-between items-center mb-6">
                                        <h2 className="text-xl text-white font-bold">Daily Signals</h2>
                                        <span className="text-xs text-slate-500 bg-slate-900 px-2 py-1 rounded font-mono">
                                            {status?.date ? formatDate(status.date) : 'TODAY'}
                                        </span>
                                    </div>
                                    <SignalsTable signals={signals} />
                                </div>
                            )}

                            {activeTab === 'logs' && (
                                <div className="space-y-2">
                                    <div className="bg-black border border-slate-800 rounded-t-lg p-2 flex items-center gap-2">
                                        <div className="w-3 h-3 rounded-full bg-red-500"></div>
                                        <div className="w-3 h-3 rounded-full bg-yellow-500"></div>
                                        <div className="w-3 h-3 rounded-full bg-green-500"></div>
                                        <span className="text-xs text-slate-500 ml-2 font-mono">Terminal Output</span>
                                    </div>
                                    <LogViewer logFile={status?.log_file} content={rawLogs} />
                                    <div className="text-center text-xs text-slate-600 mt-2">
                                        * Ïù¥ Î°úÍ∑∏Îäî ÏùΩÍ∏∞ Ï†ÑÏö©Ïù¥Î©∞, ÏàòÏ†ïÌï† Ïàò ÏóÜÏäµÎãàÎã§.
                                    </div>
                                </div>
                            )}
                        </main>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>