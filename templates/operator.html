<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KRX Operator Dashboard</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #1e1e1e;
            color: #d4d4d4;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
            padding-bottom: 20px;
            margin-bottom: 20px;
        }

        /* P145: Mode Banner */
        .mode-banner {
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.95em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .mode-banner.live {
            background: #1a3a1a;
            border: 1px solid #4ec9b0;
            color: #4ec9b0;
        }

        .mode-banner.replay {
            background: #3a1a1a;
            border: 1px solid #f48771;
            color: #f48771;
        }

        .mode-banner.dry-run {
            background: #1a2a3a;
            border: 1px solid #569cd6;
            color: #569cd6;
        }

        .mode-badge {
            font-weight: bold;
            font-size: 1.1em;
        }

        .mode-detail {
            font-size: 0.85em;
            opacity: 0.8;
        }

        .status-box {
            background: #252526;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
            border: 1px solid #333;
        }

        .stage-label {
            font-size: 0.9em;
            color: #888;
        }

        .stage-value {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
            color: #4ec9b0;
        }

        .action-box {
            background: #333333;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .action-title {
            font-size: 1.2em;
            color: #569cd6;
            margin-bottom: 10px;
        }

        .command-block {
            background: #000;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            color: #ce9178;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .copy-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 4px;
        }

        .copy-btn:hover {
            background: #555;
        }

        .artifacts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .artifact-card {
            background: #252526;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #333;
        }

        .artifact-link {
            color: #9cdcfe;
            text-decoration: none;
            font-size: 1.1em;
            display: block;
            margin-bottom: 5px;
        }

        .artifact-link:hover {
            text-decoration: underline;
        }

        .refresh-btn {
            background: #0e639c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }

        .error {
            color: #f48771;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        th,
        td {
            text-align: left;
            padding: 10px;
            border-bottom: 1px solid #333;
        }

        th {
            background-color: #252526;
            color: #ccc;
        }

        /* P145: Trace Info */
        .trace-box {
            background: #1a1a2e;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-family: monospace;
            font-size: 0.85em;
        }

        .trace-box .trace-item {
            display: inline-block;
            margin-right: 20px;
            color: #888;
        }

        .trace-box .trace-item span {
            color: #dcdcaa;
        }

        /* P145: DRY_RUN button */
        .dry-run-btn {
            background: #569cd6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
        }

        .dry-run-btn:hover {
            background: #4a8bc2;
        }

        /* P145: No Action Notice */
        .no-action-notice {
            background: #252526;
            border: 1px solid #555;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
        }

        .no-action-notice .emoji {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .no-action-notice .text {
            color: #888;
            font-size: 1.1em;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>KRX Operator Dashboard</h1>
            <button class="refresh-btn" onclick="fetchData()">Refresh</button>
        </div>

        <!-- P145: Mode Banner -->
        <div id="mode-banner" class="mode-banner live" style="display:none;">
            <div>
                <span class="mode-badge" id="mode-badge-text">üü¢ LIVE</span>
                <span class="mode-detail" id="mode-detail-text"></span>
            </div>
            <div class="mode-detail" id="mode-exec-text"></div>
        </div>

        <div id="status-container" class="status-box">
            <span class="stage-label">Current Stage (SSOT)</span>
            <div id="stage-value" class="stage-value">LOADING...</div>
            <div id="asof-value" class="stage-label"></div>
        </div>

        <!-- P145: No Action Notice (shown for NO_ACTION_TODAY) -->
        <div id="no-action-notice" class="no-action-notice" style="display:none;">
            <div class="emoji">üóìÔ∏è</div>
            <div class="text">Ïò§ÎäòÏùÄ Ïï°ÏÖò ÏóÜÏùå (Holiday/Weekend)</div>
            <div style="color:#555; margin-top:10px; font-size:0.85em;" id="no-action-hint"></div>
        </div>

        <!-- P145: Trace Box -->
        <div id="trace-box" class="trace-box" style="display:none;">
            üìã Trace:
            <span class="trace-item">plan_id: <span id="trace-plan-id">N/A</span></span>
            <span class="trace-item">asof: <span id="trace-asof">N/A</span></span>
            <span class="trace-item">mode: <span id="trace-mode">LIVE</span></span>
        </div>

        <!-- P139: Portfolio & Signals -->
        <h3>Portfolio & Signals</h3>
        <div class="status-box" style="text-align: left;">
            <table>
                <thead>
                    <tr>
                        <th>Ticker</th>
                        <th>Qty</th>
                        <th>PnL %</th>
                        <th>Signal</th>
                        <th>Reason</th>
                    </tr>
                </thead>
                <tbody id="portfolio-body">
                    <tr>
                        <td colspan="5" style="text-align:center;">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div id="action-container" class="action-box" style="display:none;">
            <div class="action-title" id="action-title">Next Action</div>
            <div class="command-block">
                <span id="action-command"></span>
                <button class="copy-btn" onclick="copyCommand()">Copy</button>
            </div>
            <div id="action-notes" style="margin-top: 10px; color: #888; font-size: 0.9em;"></div>
        </div>

        <h3>Latest Artifacts (Evidence Resolver)</h3>
        <div id="artifacts-grid" class="artifacts-grid">
            <!-- Artifacts injected here -->
        </div>

        <!-- Token Forms (P144) -->
        <div id="prep-container" class="action-box" style="display:none; border: 1px solid #ce9178;">
            <div class="action-title" style="color: #ce9178;">‚ö†Ô∏è EXECUTION PREPARATION REQUIRED</div>
            <p style="color: #ccc; font-size: 0.9em;">Enter your Ops Token to authorize Execution Prep.</p>
            <input type="password" id="prep-token" placeholder="Enter Token"
                style="padding: 8px; width: 200px; background: #252526; border: 1px solid #555; color: white;">
            <button class="refresh-btn" style="background: #ce9178;" onclick="runPrep()">RUN PREP</button>
            <div id="prep-status" style="margin-top: 10px; font-size: 0.9em;"></div>
        </div>

        <!-- P145: DRY_RUN 1-Click Submit (shown in REPLAY + AWAITING_RECORD_SUBMIT) -->
        <div id="dryrun-container" class="action-box" style="display:none; border: 1px solid #569cd6;">
            <div class="action-title" style="color: #569cd6;">üß™ DRY_RUN RECORD SUBMIT</div>
            <p style="color: #ccc; font-size: 0.9em;">Replay Î™®Îìú: Ïã§Í±∞Îûò ÏóÜÏù¥ DRY_RUNÏúºÎ°ú Î£®ÌîÑÎ•º ÏôÑÏ£ºÌï©ÎãàÎã§.</p>
            <button class="dry-run-btn" onclick="submitDryRun()">üß™ DRY_RUN 1-Click Submit</button>
            <div id="dryrun-status" style="margin-top: 10px; font-size: 0.9em;"></div>
        </div>

        <!-- P146.5: Draft Manager (Server-Side) -->
        <div id="draft-container" class="action-box" style="display:none; border: 1px solid #9cdcfe;">
            <div class="action-title" style="color: #9cdcfe;">üíæ DRAFT RECORD MANAGER</div>
            <p style="color: #ccc; font-size: 0.9em;">Server-side Draft Generation & Submission (No Upload Required)</p>

            <!-- P146.5: Plan ID Consistency Bar -->
            <div id="plan-id-bar"
                style="padding: 8px 12px; border-radius: 4px; margin-bottom: 15px; font-size: 0.85em; font-family: monospace;">
            </div>

            <!-- 1. Generate -->
            <div style="margin-bottom: 20px;">
                <button id="btn-generate-draft" class="refresh-btn" style="background: #0e639c;"
                    onclick="generateDraft()">1. GENERATE DRAFT
                    (SERVER)</button>
                <span id="draft-status" style="margin-left: 10px; font-size: 0.9em; color: #888;"></span>
            </div>

            <div id="draft-actions" style="display:none; border-top: 1px solid #444; padding-top: 20px;">
                <!-- 2. Preview -->
                <div style="margin-bottom: 20px;">
                    <label style="color: #9cdcfe; font-size: 0.9em; display:block; margin-bottom:5px;">2. DRAFT PREVIEW
                        (Read-Only)</label>
                    <textarea id="draft-preview" readonly
                        style="width: 100%; height: 150px; background: #1e1e1e; color: #d4d4d4; border: 1px solid #555; font-family: monospace; font-size: 0.85em; padding: 10px;"></textarea>
                    <div style="text-align: right; margin-top: 5px;">
                        <a id="draft-download-link" href="#" target="_blank"
                            style="color: #9cdcfe; font-size: 0.85em; text-decoration: none;">‚¨áÔ∏è Download JSON</a>
                    </div>
                </div>

                <!-- 3. Token & Submit -->
                <div style="background: #252526; padding: 15px; border-radius: 6px; border: 1px solid #444;">
                    <label style="color: #4ec9b0; font-size: 0.9em; font-weight: bold;">3. SUBMIT DRAFT</label>
                    <p style="font-size: 0.8em; color: #888; margin: 5px 0 10px 0;">
                        ‚ÑπÔ∏è Token is the <code>confirm_token</code> found in the <b>TICKET</b> or <b>EXPORT</b> artifact.
                    </p>

                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="position: relative;">
                            <input type="password" id="draft-token" placeholder="Enter Token"
                                style="padding: 8px 30px 8px 10px; width: 220px; background: #1e1e1e; border: 1px solid #555; color: white;">
                            <span onclick="toggleDraftToken()"
                                style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); cursor: pointer; opacity: 0.7;">üëÅÔ∏è</span>
                        </div>

                        <button class="refresh-btn" style="background: #4ec9b0; font-weight: bold;"
                            onclick="submitDraftServer()">SUBMIT DRAFT</button>
                    </div>
                    <div id="draft-submit-status" style="margin-top: 10px; font-size: 0.9em;"></div>
                </div>
            </div>
        </div>

        <!-- Standard Record Submit (Upload Fallback) -->
        <details id="submit-container" class="action-box" style="display:none; border: 1px solid #555; padding: 10px;">
            <summary class="action-title" style="color: #888; cursor: pointer; font-size: 1em;">üöÄ RECORD UPLOAD (LEGACY
                / ADVANCED)</summary>

            <div style="padding: 15px; border-top: 1px solid #444; margin-top: 10px;">
                <p style="color: #888; font-size: 0.8em;">Use this only if you need to upload a manually modified JSON
                    file.</p>

                <div style="margin-bottom: 10px;">
                    <input type="file" id="record-file" accept=".json" style="color: #ccc;">
                </div>

                <div style="margin-bottom: 10px;">
                    <input type="password" id="submit-token" placeholder="Enter Token"
                        style="padding: 8px; width: 200px; background: #252526; border: 1px solid #555; color: white;">
                    <button class="refresh-btn" style="background: #555;" onclick="submitRecord()">SUBMIT
                        (UPLOAD)</button>
                </div>
                <div id="submit-status" style="margin-top: 10px; font-size: 0.9em;"></div>
            </div>
        </details>
    </div>

    <script>
        // P146.2: Global State
        let currentDraftExists = false;

        async function fetchData() {
            try {
                const res = await fetch('/api/operator/dashboard');
                const data = await res.json();

                // ... (Existing Rendering Logic) ...

                // Stage
                const stageEl = document.getElementById('stage-value');
                stageEl.textContent = data.stage;
                stageEl.style.color = data.stage === 'DONE_TODAY' ? '#4ec9b0' :
                    data.stage === 'CHECK_BACKEND' ? '#f48771' : '#dcdcaa';

                document.getElementById('asof-value').textContent = "As Of: " + data.asof;

                // P145: Mode Banner
                const modeBanner = document.getElementById('mode-banner');
                const modeBadge = document.getElementById('mode-badge-text');
                const modeDetail = document.getElementById('mode-detail-text');
                const modeExec = document.getElementById('mode-exec-text');
                modeBanner.style.display = 'flex';

                const isReplay = data.replay_info && data.replay_info.enabled;
                const isDryRun = data.exec_mode === 'DRY_RUN';
                const simTrade = data.replay_info && data.replay_info.simulate_trade_day;

                if (isReplay) {
                    modeBanner.className = 'mode-banner replay';
                    modeBadge.textContent = 'üî¥ REPLAY MODE';
                    let detail = `Data Basis: ${data.replay_info.asof}`;
                    if (simTrade) detail += ' [SIM-TRADE ‚úì]';
                    modeDetail.textContent = detail;
                } else {
                    modeBanner.className = 'mode-banner live';
                    modeBadge.textContent = 'üü¢ LIVE MODE';
                    modeDetail.textContent = '';
                }
                if (isDryRun) {
                    modeBanner.className = 'mode-banner dry-run';
                    modeExec.textContent = 'üß™ Execution: DRY_RUN';
                } else {
                    modeExec.textContent = isReplay ? '' : 'üîµ Execution: LIVE';
                }

                // ... (No Action Notice, Trace Box, Action Box logic unchanged) ...

                // P146.2: Draft Status
                currentDraftExists = data.draft_exists;
                const draftDownloadLink = document.getElementById('draft-download-link');
                const draftActions = document.getElementById('draft-actions');

                if (currentDraftExists) {
                    draftActions.style.display = 'block';
                    draftDownloadLink.href = "/api/manual_execution_record/draft";
                    document.getElementById('draft-status').textContent = "‚úÖ Draft Available on Server";
                    document.getElementById('draft-status').style.color = "#4ec9b0";
                } else {
                    draftActions.style.display = 'none';
                    document.getElementById('draft-status').textContent = "";
                }

                // P146.5: Plan ID Consistency Bar + Button Gating
                const planBar = document.getElementById('plan-id-bar');
                const btnGenerate = document.getElementById('btn-generate-draft');
                const chk = data.plan_id_check;

                if (chk) {
                    if (chk.match) {
                        const id = chk.export_plan_id || chk.ticket_plan_id || chk.prep_plan_id || 'N/A';
                        planBar.style.background = '#1a3a1a';
                        planBar.style.border = '1px solid #4ec9b0';
                        planBar.style.color = '#4ec9b0';
                        planBar.innerHTML = `‚úÖ plan_id ÏùºÏπò: <b>${id}</b>`;
                        btnGenerate.disabled = false;
                        btnGenerate.style.opacity = '1';
                    } else {
                        planBar.style.background = '#3a1a1a';
                        planBar.style.border = '1px solid #f48771';
                        planBar.style.color = '#f48771';
                        const isLive = data.exec_mode !== 'DRY_RUN';
                        planBar.innerHTML = `‚ùå plan_id Î∂àÏùºÏπò ‚Äî ` +
                            `prep: <b>${chk.prep_plan_id || 'ÏóÜÏùå'}</b> | ` +
                            `ticket: <b>${chk.ticket_plan_id || 'ÏóÜÏùå'}</b> | ` +
                            `export: <b>${chk.export_plan_id || 'ÏóÜÏùå'}</b>` +
                            `<br><span style="color:#ccc; font-size:0.9em;">TicketÏùÑ ExportÏóê ÎßûÏ∂∞ Ïû¨ÏÉùÏÑ±ÌïòÏÑ∏Ïöî.</span>` +
                            `<br><button id="btn-regen-ticket" onclick="regenTicket(${isLive})" ` +
                            `style="margin-top:8px; padding:6px 16px; background:#b5854b; color:#fff; border:none; border-radius:4px; cursor:pointer; font-weight:bold;">` +
                            `üîÑ TICKET Ïû¨ÏÉùÏÑ± (ExportÏóê ÎßûÏ∂§)</button>` +
                            `<span id="regen-status" style="margin-left:10px; font-size:0.85em;"></span>`;
                        btnGenerate.disabled = true;
                        btnGenerate.style.opacity = '0.4';
                    }
                }

                // Toggle Forms
                const prepContainer = document.getElementById('prep-container');
                const submitContainer = document.getElementById('submit-container');
                const dryrunContainer = document.getElementById('dryrun-container');
                const draftContainer = document.getElementById('draft-container');

                // Reset
                prepContainer.style.display = 'none';
                submitContainer.style.display = 'none';
                dryrunContainer.style.display = 'none';
                draftContainer.style.display = 'none';

                if (data.stage === 'NEED_HUMAN_CONFIRM') {
                    prepContainer.style.display = 'block';
                } else if (['AWAITING_HUMAN_EXECUTION', 'AWAITING_RECORD_SUBMIT', 'AWAITING_RETRY_EXECUTION'].includes(data.stage)) {
                    // P146.2: Show Draft Manager
                    draftContainer.style.display = 'block';

                    // Show upload fallback only if NO draft exists yet? Or always?
                    // Let's show it always but minimized visually (logic in CSS above)
                    submitContainer.style.display = 'block';
                }

                // ... (Portfolio, Artifacts logic unchanged) ...

                // Artifacts Grid (Fail-Soft Preview not here, links handled by backend)
                // We just render links.
                const grid = document.getElementById('artifacts-grid');
                grid.innerHTML = '';
                if (data.artifacts) {
                    for (const [key, path] of Object.entries(data.artifacts)) {
                        const card = document.createElement('div');
                        card.className = 'artifact-card';

                        const link = document.createElement('a');
                        link.className = 'artifact-link';
                        link.href = `/api/evidence/resolve?ref=${encodeURIComponent(path)}`;
                        let label = key.toUpperCase().replace(/_/g, ' ');

                        // P146.3: Rename Record to avoid confusion
                        if (key === 'manual_execution_record') {
                            label = "RECORD (VIEW ONLY)";
                            card.style.border = "1px solid #4ec9b0";
                        }

                        link.textContent = label;
                        link.target = "_blank";

                        const pathSpan = document.createElement('div');
                        pathSpan.style.fontSize = '0.8em';
                        pathSpan.style.color = '#666';
                        pathSpan.textContent = path.split('/').pop();

                        card.appendChild(link);
                        card.appendChild(pathSpan);
                        grid.appendChild(card);
                    }
                }

            } catch (e) {
                console.error(e);
            }
        }
        // P146.6: Ticket Regeneration
        async function regenTicket(isLive) {
            if (isLive) {
                if (!confirm('‚ö†Ô∏è LIVE Î™®ÎìúÏûÖÎãàÎã§. TicketÏùÑ Ïû¨ÏÉùÏÑ±ÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
            }
            const statusSpan = document.getElementById('regen-status');
            statusSpan.textContent = '‚è≥ Ïû¨ÏÉùÏÑ± Ï§ë...';
            statusSpan.style.color = '#ccc';

            try {
                const res = await fetch('/api/manual_execution_ticket/regenerate', { method: 'POST' });
                const data = await res.json();

                if (data.result === 'OK') {
                    statusSpan.textContent = `‚úÖ ÏôÑÎ£å (plan_id: ${data.plan_id})`;
                    statusSpan.style.color = '#4ec9b0';
                    setTimeout(fetchData, 500);
                } else {
                    statusSpan.textContent = `‚ùå ${data.reason || 'Unknown'}`;
                    statusSpan.style.color = '#f48771';
                }
            } catch (e) {
                statusSpan.textContent = `‚ùå Error: ${e.message}`;
                statusSpan.style.color = '#f48771';
            }
        }

        // P146.3: Draft Functions
        async function generateDraft() {
            const statusDiv = document.getElementById('draft-status');
            statusDiv.textContent = "‚è≥ Generating...";
            statusDiv.style.color = "#ccc";

            try {
                const res = await fetch('/api/manual_execution_record/draft', { method: 'POST' });
                const data = await res.json();

                if (data.result === 'OK') {
                    statusDiv.textContent = "‚úÖ Draft Generated!";
                    statusDiv.style.color = "#4ec9b0";

                    // Auto-load Preview
                    await loadDraftPreview();

                    fetchData(); // Refresh UI state
                } else {
                    let msg = "‚ùå " + (data.reason || "Unknown");
                    if (data.guidance) msg += "\n" + data.guidance;
                    if (data.detail) msg += "\n" + JSON.stringify(data.detail);
                    statusDiv.textContent = msg;
                    statusDiv.style.color = "#f48771";
                    statusDiv.style.whiteSpace = "pre-wrap";
                }
            } catch (e) {
                statusDiv.textContent = "‚ùå Error: " + e.message;
            }
        }

        async function loadDraftPreview() {
            try {
                const res = await fetch('/api/manual_execution_record/draft');
                if (res.ok) {
                    const json = await res.json();
                    document.getElementById('draft-preview').value = JSON.stringify(json, null, 2);
                    document.getElementById('draft-actions').style.display = 'block';
                }
            } catch (e) {
                console.error("Preview Load Failed", e);
            }
        }

        function toggleDraftToken() {
            const input = document.getElementById('draft-token');
            input.type = input.type === "password" ? "text" : "password";
        }

        async function submitDraftServer() {
            const token = document.getElementById('draft-token').value;
            const statusDiv = document.getElementById('draft-submit-status');
            const previewContent = document.getElementById('draft-preview').value;

            if (!token) {
                statusDiv.textContent = "‚ùå Token is required";
                return;
            }

            statusDiv.textContent = "‚è≥ Submitting...";

            try {
                let payload = {};

                // Use Preview Content if available, else fetch
                if (previewContent) {
                    try {
                        const draftJson = JSON.parse(previewContent);
                        payload = { ...draftJson, confirm_token: token };
                    } catch (e) {
                        statusDiv.textContent = "‚ùå Invalid JSON in Preview";
                        return;
                    }
                } else {
                    // Fallback fetch
                    const draftRes = await fetch('/api/manual_execution_record/draft');
                    if (!draftRes.ok) throw new Error("Could not fetch draft content");
                    const draftJson = await draftRes.json();
                    payload = { ...draftJson, confirm_token: token };
                }

                // 3. Submit
                const res = await fetch('/api/manual_execution_record/submit?confirm=true', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();

                if (data.decision === 'EXECUTED' || data.decision === 'SKIPPED' || data.result === 'OK') {
                    statusDiv.textContent = "‚úÖ Submit Success!";
                    statusDiv.style.color = "#4ec9b0";

                    // Update Summary
                    await fetch('/api/ops/summary/regenerate?confirm=true', { method: 'POST' });

                    setTimeout(fetchData, 1000);
                } else {
                    let errMsg = data.reason || data.message || "Unknown Error";
                    if (data.detail) errMsg += " " + JSON.stringify(data.detail);
                    statusDiv.textContent = "‚ùå Submit Failed: " + errMsg;
                    statusDiv.style.color = "#f48771";
                }

            } catch (e) {
                statusDiv.textContent = "‚ùå Error: " + e.message;
                statusDiv.style.color = "#f48771";
            }
        }

        async function runPrep() {
            const token = document.getElementById('prep-token').value;
            const statusDiv = document.getElementById('prep-status');

            if (!token) {
                statusDiv.textContent = "‚ùå Token is required";
                statusDiv.style.color = "#f48771";
                return;
            }

            statusDiv.textContent = "‚è≥ Running Prep...";
            statusDiv.style.color = "#ccc";

            try {
                const res = await fetch('/api/execution_prep/prepare?confirm=true', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ confirm_token: token })
                });
                const data = await res.json();

                if (data.decision === 'READY' || data.result === 'OK' || data.decision === 'WARN') {
                    statusDiv.textContent = "‚úÖ Prep Success! Generating Ticket...";
                    statusDiv.style.color = "#4ec9b0";

                    // Auto generate ticket
                    await fetch('/api/manual_execution_ticket/regenerate?confirm=true', { method: 'POST' });

                    // Update Summary
                    await fetch('/api/ops/summary/regenerate?confirm=true', { method: 'POST' });

                    setTimeout(fetchData, 1000); // Refresh UI
                } else {
                    statusDiv.textContent = "‚ùå Prep Failed: " + (data.reason || data.message || "Unknown");
                    statusDiv.style.color = "#f48771";
                }
            } catch (e) {
                statusDiv.textContent = "‚ùå Error: " + e.message;
                statusDiv.style.color = "#f48771";
            }
        }

        // P145: DRY_RUN 1-Click Submit
        async function submitDryRun() {
            const statusDiv = document.getElementById('dryrun-status');
            statusDiv.textContent = "‚è≥ Submitting DRY_RUN Record...";
            statusDiv.style.color = "#ccc";

            try {
                const res = await fetch('/api/dry_run_record/submit?confirm=true', {
                    method: 'POST'
                });
                const data = await res.json();

                if (data.result === 'OK' || data.decision === 'EXECUTED') {
                    statusDiv.textContent = "‚úÖ DRY_RUN Complete!";
                    statusDiv.style.color = "#4ec9b0";

                    // Update Summary
                    await fetch('/api/ops/summary/regenerate?confirm=true', { method: 'POST' });

                    setTimeout(fetchData, 1000);
                } else {
                    statusDiv.textContent = "‚ùå DRY_RUN Failed: " + (data.detail || data.reason || "Unknown");
                    statusDiv.style.color = "#f48771";
                }
            } catch (e) {
                statusDiv.textContent = "‚ùå Error: " + e.message;
                statusDiv.style.color = "#f48771";
            }
        }

        async function submitRecord() {
            const token = document.getElementById('submit-token').value;
            const fileInput = document.getElementById('record-file');
            const statusDiv = document.getElementById('submit-status');

            if (!token) {
                statusDiv.textContent = "‚ùå Token is required";
                statusDiv.style.color = "#f48771";
                return;
            }
            if (fileInput.files.length === 0) {
                statusDiv.textContent = "‚ùå JSON File is required";
                statusDiv.style.color = "#f48771";
                return;
            }

            statusDiv.textContent = "‚è≥ Reading File...";
            statusDiv.style.color = "#ccc";

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = async function (e) {
                try {
                    const jsonContent = JSON.parse(e.target.result);

                    // Inject Token - Robustness for List or Dict inputs
                    let payload = {};
                    if (Array.isArray(jsonContent)) {
                        payload = { confirm_token: token, items: jsonContent };
                    } else {
                        payload = { ...jsonContent, confirm_token: token };
                    }

                    statusDiv.textContent = "‚è≥ Submitting...";

                    const res = await fetch('/api/manual_execution_record/submit?confirm=true', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const data = await res.json();

                    if (data.decision === 'EXECUTED' || data.decision === 'SKIPPED' || data.result === 'OK') {
                        statusDiv.textContent = "‚úÖ Submit Success!";
                        statusDiv.style.color = "#4ec9b0";

                        // Update Summary
                        await fetch('/api/ops/summary/regenerate?confirm=true', { method: 'POST' });

                        setTimeout(fetchData, 1000);
                    } else {
                        let errMsg = data.reason || data.message || "Unknown Error";
                        if (data.detail) {
                            if (typeof data.detail === 'object') {
                                errMsg += " Details: " + JSON.stringify(data.detail);
                            } else {
                                errMsg += " Details: " + data.detail;
                            }
                        }
                        statusDiv.textContent = "‚ùå Submit Failed: " + errMsg;
                        statusDiv.style.color = "#f48771";
                    }

                } catch (err) {
                    statusDiv.textContent = "‚ùå JSON Parse/Upload Error: " + err.message;
                    statusDiv.style.color = "#f48771";
                }
            };

            reader.readAsText(file);
        }

        function copyCommand() {
            const cmd = document.getElementById('action-command').textContent;
            navigator.clipboard.writeText(cmd).then(() => {
                alert("Command Copied!");
            });
        }

        // Init
        fetchData();
        setInterval(fetchData, 10000); // Poll every 10s
    </script>
</body>

</html>