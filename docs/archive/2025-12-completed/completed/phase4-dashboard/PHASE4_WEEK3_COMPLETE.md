# Phase 4 Week 3 완료: 레짐별 손절 & 재매수 시스템 (2025-11-13)

## 🎯 **목표**

시장 레짐과 변동성을 고려한 고도화된 손절 전략 및 재매수 시스템을 구축합니다.

---

## ✅ **완료된 작업**

### **1. 레짐별 손절 전략 구현** ✅

#### **파일:** `scripts/phase4/regime_based_stop_loss.py`

**핵심 개념:**
```python
# 레짐별 손절 기준
STOP_LOSS_BY_REGIME = {
    'bull': -7.0,      # 상승장: 공격적 (추세 유지)
    'neutral': -5.0,   # 중립장: 중립 (빠른 손절)
    'bear': -3.0       # 하락장: 방어적 (매우 빠른 손절)
}
```

**기능:**
```python
class RegimeBasedStopLoss:
    """레짐별 손절 전략"""
    
    def get_current_regime(self):
        """현재 시장 레짐 감지 (KOSPI 기준)"""
        
    def get_stop_loss_threshold(self, regime):
        """레짐에 따른 손절 기준 반환"""
        
    def check_holdings_by_regime(self):
        """레짐별 손절 대상 체크"""
        
    def send_alert(self):
        """텔레그램 알림 전송"""
```

**알림 메시지 예시:**
```
🎯 레짐별 손절 모니터링

📅 2025년 11월 15일 15:30

📊 시장 레짐
현재 레짐: 하락장 (신뢰도: 87.5%)
손절 기준: -3.0%

하락장 전략: 빠른 손절, 방어적 운영

🔴 손절 대상 (2개)

1. ABC ETF (123456)
   손실률: -4.2% (기준 초과: -1.2%p)
   손실 금액: -42,000원
   ⚠️ 즉시 매도 검토

2. XYZ 주식 (654321)
   손실률: -3.5% (기준 초과: -0.5%p)
   손실 금액: -35,000원
   ⚠️ 즉시 매도 검토

📋 액션 가이드
• 손절 대상: 레짐 기준 (-3.0%) 초과, 즉시 매도
• 현재 레짐: 하락장 (손절 기준 자동 조정)
```

**장점:**
```
✅ 시장 상황에 맞는 유연한 손절
✅ 상승장에서 추세 유지 (-7%)
✅ 하락장에서 빠른 손절 (-3%)
✅ 레짐 자동 감지 및 적용
```

---

### **2. 재매수 시스템 구현** ✅

#### **파일:** `scripts/phase4/rebuy_system.py`

**재매수 조건:**
```python
REBUY_CONDITIONS = {
    'cooldown_days': 5,          # 쿨다운 기간 (거래일)
    'consecutive_up_days': 5,    # 연속 상승일 (기술적 반등)
    'maps_threshold': 0.0,       # MAPS 점수 임계값 (양전환)
    'regime_change': True        # 레짐 변경 필요 여부
}
```

**기능:**
```python
class RebuySystem:
    """재매수 시스템"""
    
    def add_stop_loss_record(self):
        """손절 기록 추가 (손절 시 호출)"""
        
    def check_rebuy_candidates(self):
        """재매수 후보 종목 체크"""
        
    def _check_rebuy_conditions(self):
        """재매수 조건 충족 여부 확인"""
        
    def send_alert(self):
        """재매수 후보 알림 전송"""
```

**재매수 조건 체크:**
```
1. 쿨다운 기간 완료 (5거래일)
   → 감정적 재매수 방지

2. 기술적 반등 확인 (5일 연속 상승)
   → 추세 전환 확인

3. MAPS 점수 양전환 (음수 → 양수)
   → 펀더멘털 개선

4. 레짐 변경 (하락 → 중립/상승)
   → 시장 환경 개선
```

**알림 메시지 예시:**
```
🔄 재매수 후보 알림

📅 2025년 11월 20일 10:00

재매수 후보 (2개)
손절 후 재진입 조건 충족

1. ABC ETF (123456)
   손절일: 2025-11-13
   손절 손실: -8.5%
   충족 조건:
     ✅ 쿨다운 기간 완료
     ✅ 기술적 반등 확인
     ✅ MAPS 양전환 (레짐: bull)
     ✅ 레짐 개선 (bull)
   💡 재매수 검토 가능

📋 재매수 가이드
• 현재가 확인 후 진입
• 소량 분할 매수 권장
• 손절 기준 재설정 필수
• 감정적 판단 배제
```

**장점:**
```
✅ 체계적인 재진입 프로세스
✅ 감정적 재매수 방지 (쿨다운)
✅ 기술적/펀더멘털 확인
✅ 손절 이력 자동 관리
```

---

### **3. 동적 손절 기준 구현** ✅

#### **파일:** `scripts/phase4/dynamic_stop_loss.py`

**변동성 기반 손절:**
```python
VOLATILITY_THRESHOLDS = {
    'low': {
        'atr_max': 2.0,          # ATR 2% 이하
        'stop_loss': -5.0        # 손절 -5%
    },
    'medium': {
        'atr_min': 2.0,
        'atr_max': 5.0,          # ATR 2~5%
        'stop_loss': -7.0        # 손절 -7%
    },
    'high': {
        'atr_min': 5.0,          # ATR 5% 이상
        'stop_loss': -10.0       # 손절 -10%
    }
}
```

**기능:**
```python
class DynamicStopLoss:
    """동적 손절 기준"""
    
    def calculate_atr(self, code):
        """ATR (Average True Range) 계산"""
        
    def classify_volatility(self, atr):
        """변동성 구간 분류"""
        
    def get_stop_loss_threshold(self, code):
        """종목별 동적 손절 기준 계산"""
        
    def check_holdings_with_dynamic_stop_loss(self):
        """동적 손절 기준으로 보유 종목 체크"""
```

**변동성 구간별 전략:**
```
저변동성 종목 (ATR ≤2%):
- 예: 대형 ETF, 우량주
- 손절 기준: -5%
- 이유: 안정적이므로 빠른 손절

중변동성 종목 (ATR 2~5%):
- 예: 일반 ETF, 중형주
- 손절 기준: -7%
- 이유: 표준 손절 기준

고변동성 종목 (ATR ≥5%):
- 예: 테마주, 소형주
- 손절 기준: -10%
- 이유: 변동성 고려한 여유
```

**알림 메시지 예시:**
```
📊 동적 손절 모니터링

📅 2025년 11월 15일 15:30
변동성 기반 맞춤 손절 기준

📈 변동성 구간별 손절 기준
• 저변동성 (ATR ≤2%): -5%
• 중변동성 (ATR 2~5%): -7%
• 고변동성 (ATR ≥5%): -10%

🔴 손절 대상 (2개)

1. ABC ETF (123456)
   손실률: -6.2%
   손절 기준: -5% (저변동성, ATR: 1.8%)
   기준 초과: -1.2%p
   손실 금액: -62,000원
   ⚠️ 즉시 매도 검토

2. XYZ 주식 (654321)
   손실률: -11.5%
   손절 기준: -10% (고변동성, ATR: 6.3%)
   기준 초과: -1.5%p
   손실 금액: -115,000원
   ⚠️ 즉시 매도 검토

📋 액션 가이드
• 손절 대상: 변동성 고려한 맞춤 기준 초과, 즉시 매도
• 동적 손절: 종목별 변동성에 따라 기준 자동 조정
```

**장점:**
```
✅ 종목별 맞춤 손절 기준
✅ 변동성 고려한 유연한 운영
✅ 고변동성 종목 과도한 손절 방지
✅ 저변동성 종목 빠른 손절
```

---

## 📊 **3가지 손절 전략 비교**

### **1. 고정 손절 (Week 2)**
```
기준: -7% (고정)
장점: 단순, 명확
단점: 시장/종목 특성 미반영
적용: Phase 4 Week 2
```

### **2. 레짐별 손절 (Week 3)**
```
기준:
- 상승장: -7%
- 중립장: -5%
- 하락장: -3%

장점: 시장 상황 반영
단점: 종목 특성 미반영
적용: Phase 4 Week 3
```

### **3. 동적 손절 (Week 3)**
```
기준:
- 저변동성: -5%
- 중변동성: -7%
- 고변동성: -10%

장점: 종목 특성 반영
단점: 계산 복잡도 증가
적용: Phase 4 Week 3
```

### **4. 하이브리드 (권장)**
```
레짐별 + 동적 손절 조합:

상승장 + 저변동성: -5%
상승장 + 중변동성: -7%
상승장 + 고변동성: -10%

중립장 + 저변동성: -4%
중립장 + 중변동성: -5%
중립장 + 고변동성: -7%

하락장 + 저변동성: -3%
하락장 + 중변동성: -3%
하락장 + 고변동성: -5%

장점: 시장 + 종목 모두 반영
단점: 복잡도 최고
적용: Phase 4 Week 4 (예정)
```

---

## 🧪 **테스트 방법**

### **1. 레짐별 손절 테스트**
```bash
python scripts/phase4/regime_based_stop_loss.py

# 예상 출력:
# - 현재 레짐 감지
# - 레짐별 손절 기준 적용
# - 손절 대상 종목 리스트
# - 텔레그램 알림 전송
```

### **2. 재매수 시스템 테스트**
```bash
python scripts/phase4/rebuy_system.py

# 예상 출력:
# - 손절 이력 로드
# - 재매수 후보 체크
# - 재매수 조건 충족 여부
# - 텔레그램 알림 전송
```

### **3. 동적 손절 테스트**
```bash
python scripts/phase4/dynamic_stop_loss.py

# 예상 출력:
# - 종목별 ATR 계산
# - 변동성 구간 분류
# - 동적 손절 기준 적용
# - 텔레그램 알림 전송
```

---

## 📝 **생성된 파일**

### **스크립트 (3개)**
```
✅ scripts/phase4/regime_based_stop_loss.py (418줄)
✅ scripts/phase4/rebuy_system.py (395줄)
✅ scripts/phase4/dynamic_stop_loss.py (456줄)
```

### **문서 (1개)**
```
✅ docs/PHASE4_WEEK3_COMPLETE.md (이 문서)
```

---

## 💡 **핵심 성과**

### **1. 레짐별 손절** ✅
```
시장 상황 반영:
- 상승장: 추세 유지 (-7%)
- 중립장: 균형 유지 (-5%)
- 하락장: 빠른 손절 (-3%)

효과:
✅ 상승장에서 과도한 손절 방지
✅ 하락장에서 빠른 손실 차단
✅ 시장 적응형 전략
```

### **2. 재매수 시스템** ✅
```
체계적 재진입:
- 쿨다운 기간 (5일)
- 기술적 반등 확인
- MAPS 양전환
- 레짐 변경

효과:
✅ 감정적 재매수 방지
✅ 조건 충족 시만 재진입
✅ 손절 이력 자동 관리
```

### **3. 동적 손절** ✅
```
종목별 맞춤:
- 저변동성: -5%
- 중변동성: -7%
- 고변동성: -10%

효과:
✅ 종목 특성 반영
✅ 고변동성 종목 과손절 방지
✅ 저변동성 종목 빠른 손절
```

---

## 🚀 **다음 단계 (Week 4)**

### **1. 하이브리드 손절 전략**
```
레짐별 + 동적 손절 조합
→ 시장 + 종목 모두 반영
→ 최적화된 손절 기준
```

### **2. 백테스트 검증**
```
3가지 손절 전략 비교:
- 고정 손절 (-7%)
- 레짐별 손절
- 동적 손절
- 하이브리드 손절

성과 지표:
- 수익률
- Sharpe Ratio
- Max Drawdown
- 손절 횟수
```

### **3. 실전 적용**
```
최적 전략 선택:
- 백테스트 결과 기반
- 실전 테스트
- 성과 모니터링
```

### **4. Phase 4 완료 보고서**
```
전체 성과 요약:
- Week 1: 손절 실행
- Week 2: 모니터링 & 자동화
- Week 3: 전략 개선
- Week 4: 최종 검증 및 완료
```

---

## 🎯 **Week 3 성공 기준**

### **1. 레짐별 손절 구현** ✅
```
✅ 3가지 레짐 감지 (상승/중립/하락)
✅ 레짐별 손절 기준 적용
✅ 자동 알림 시스템
```

### **2. 재매수 시스템 구현** ✅
```
✅ 손절 이력 관리
✅ 재매수 조건 체크
✅ 재매수 후보 알림
```

### **3. 동적 손절 구현** ✅
```
✅ ATR 기반 변동성 계산
✅ 변동성 구간 분류
✅ 종목별 맞춤 손절 기준
```

---

## 📊 **구버전 파일 정리**

### **제거 대상 (Week 3 커밋 시 반영)**
```bash
# 주간 리포트 구버전
scripts/automation/weekly_alert.sh
scripts/nas/weekly_report.py
scripts/automation/run_weekly_report.py

# EOD 중복 스크립트
scripts/nas/daily_realtime_signals.sh
nas/app_realtime.py (사용 안 함)

# 백업 디렉토리로 이동
mkdir -p scripts/_deprecated_2025-11-13
mv scripts/automation/weekly_alert.sh scripts/_deprecated_2025-11-13/
mv scripts/nas/weekly_report.py scripts/_deprecated_2025-11-13/
mv scripts/nas/daily_realtime_signals.sh scripts/_deprecated_2025-11-13/
mv scripts/automation/run_weekly_report.py scripts/_deprecated_2025-11-13/
```

---

## 🎉 **Week 3 완료!**

### **완료된 작업**
```
✅ 레짐별 손절 전략 구현
✅ 재매수 시스템 구현
✅ 동적 손절 기준 구현
✅ 3가지 손절 전략 완성
✅ 문서화 완료
```

### **기대 효과**
```
✅ 시장 상황 반영 손절
✅ 종목 특성 반영 손절
✅ 체계적 재매수 프로세스
✅ 감정적 판단 배제
✅ 전략 고도화 완료
```

---

**Phase 4 Week 3 완료!**  
**이제 Week 4에서 백테스트 검증 및 최종 완료합니다!** 🚀

**다음 작업:**
1. 하이브리드 손절 전략 구현
2. 백테스트 검증 (3가지 전략 비교)
3. 실전 적용 준비
4. Phase 4 완료 보고서 작성
