# 💼 포트폴리오 관리 UI 가이드

## 📋 목차
1. [개요](#개요)
2. [실행 방법](#실행-방법)
3. [기능 설명](#기능-설명)
4. [추가 매수 관리 방법](#추가-매수-관리-방법)
5. [데이터 구조](#데이터-구조)

---

## 개요

**포트폴리오 관리 UI**는 보유 ETF/주식을 쉽게 등록하고 관리할 수 있는 웹 기반 인터페이스입니다.

### ✨ 주요 기능
- ✅ 보유 종목 추가/수정/삭제
- ✅ 추가 매수 처리 (평균 단가 자동 계산)
- ✅ 현재가 자동 조회 (네이버 API)
- ✅ 평가손익 실시간 계산
- ✅ 직관적인 웹 UI (Streamlit)

### 🎯 추천 방식: 평균 단가 방식
- **매입일자 기억 안 나도 OK**: 수량과 평균 단가만 입력
- **추가 매수 자동 계산**: 새로운 평균 단가 자동 계산
- **증권사 앱과 동일**: 실전에서 가장 실용적

---

## 실행 방법

### Windows
```bash
# 방법 1: 배치 파일 실행
scripts\ui\run_portfolio_manager.bat

# 방법 2: 직접 실행
streamlit run ui/portfolio_manager.py --server.port 8502
```

### 실행 후
- 브라우저가 자동으로 열립니다
- 주소: http://localhost:8502
- 포트 충돌 시 다른 포트 사용: `--server.port 8503`

---

## 기능 설명

### 1. 📊 포트폴리오 현황

**전체 통계**
- 총 평가액
- 총 매입액
- 평가손익 (금액 + 수익률)
- 보유 종목 수

**보유 종목 목록**
| 종목명 | 코드 | 수량 | 평균단가 | 현재가 | 매입금액 | 평가금액 | 평가손익 | 수익률(%) |
|--------|------|------|----------|--------|----------|----------|----------|-----------|
| KODEX 200 | 069500 | 150 | 56,000 | 57,930 | 8,400,000 | 8,689,500 | +289,500 | +3.45 |

**버튼**
- 🔄 **현재가 업데이트**: 모든 종목의 현재가를 네이버 API로 조회
- 💾 **저장**: 포트폴리오 데이터 저장

---

### 2. ➕ 종목 추가

**입력 항목**
1. **종목 코드**: 6자리 숫자 (예: 069500)
2. **보유 수량**: 주식 수량
3. **평균 단가**: 매입 평균 가격

**자동 계산**
- 종목명 자동 조회
- 총 매입금액 자동 계산
- 현재가 자동 조회

**예시**
```
종목 코드: 069500
종목명: KODEX 200 (자동 조회)
보유 수량: 150주
평균 단가: 56,000원
→ 총 매입금액: 8,400,000원
```

---

### 3. 📈 추가 매수

**추가 매수 시나리오**
```
현재 보유:
- 수량: 150주
- 평균 단가: 56,000원
- 총 매입금액: 8,400,000원

추가 매수:
- 수량: 50주
- 단가: 58,000원
- 매수 금액: 2,900,000원

매수 후:
- 총 수량: 200주
- 평균 단가: 56,500원 (자동 계산)
- 총 매입금액: 11,300,000원
```

**평균 단가 계산 공식**
```
새 평균 단가 = (기존 총 매입금액 + 추가 매수 금액) / 총 수량
            = (8,400,000 + 2,900,000) / 200
            = 56,500원
```

---

### 4. ✏️ 종목 수정

**수정 가능 항목**
- 보유 수량
- 평균 단가

**사용 예시**
- 증권사 앱과 수량이 다를 때
- 평균 단가를 잘못 입력했을 때
- 일부 매도 후 수량 조정

---

### 5. 🗑️ 종목 삭제

**삭제 확인**
- 종목명, 수량, 평균 단가 표시
- 삭제 확인 버튼
- 취소 버튼

**사용 예시**
- 전량 매도한 종목
- 잘못 추가한 종목

---

## 추가 매수 관리 방법

### 🎯 추천: 평균 단가 방식 (현재 구현)

**장점**
- ✅ 매입일자 기억 안 나도 OK
- ✅ 추가 매수 자동 계산
- ✅ 증권사 앱과 동일
- ✅ 실전에서 가장 실용적

**사용 방법**
1. 초기 등록: 현재 보유 수량 + 평균 단가
2. 추가 매수: "📈 추가 매수" 메뉴 사용
3. 자동 계산: 새로운 평균 단가 자동 계산

**예시**
```
Day 1: KODEX 200 100주 @ 55,000원 매수
       → 등록: 100주, 평균 55,000원

Day 5: KODEX 200 50주 @ 58,000원 추가 매수
       → "추가 매수" 메뉴 사용
       → 자동 계산: 150주, 평균 56,000원

Day 10: KODEX 200 50주 @ 60,000원 추가 매수
        → "추가 매수" 메뉴 사용
        → 자동 계산: 200주, 평균 57,000원
```

---

### 📅 대안: 매입 이력 방식 (향후 구현 가능)

**장점**
- ✅ 매입일자별 상세 기록
- ✅ 매입 이력 추적 가능
- ✅ 세금 계산 정확

**단점**
- ❌ 매입일자 기억 필요
- ❌ 관리 복잡
- ❌ 입력 번거로움

**데이터 구조 (참고)**
```json
{
  "code": "069500",
  "name": "KODEX 200",
  "purchases": [
    {
      "date": "2025-11-01",
      "quantity": 100,
      "price": 55000
    },
    {
      "date": "2025-11-05",
      "quantity": 50,
      "price": 58000
    }
  ],
  "total_quantity": 150,
  "avg_price": 56000
}
```

**결론**: 현재는 평균 단가 방식으로 충분합니다. 필요시 나중에 매입 이력 방식 추가 가능.

---

## 데이터 구조

### 저장 위치
```
data/portfolio/holdings.json
```

### 데이터 형식
```json
{
  "last_updated": "2025-11-10T14:30:00",
  "initial_capital": 10000000,
  "cash": 0,
  "holdings": [
    {
      "code": "069500",
      "name": "KODEX 200",
      "quantity": 150,
      "avg_price": 56000,
      "total_cost": 8400000,
      "current_price": 57930,
      "current_value": 8689500,
      "return_amount": 289500,
      "return_pct": 3.45,
      "last_updated": "2025-11-10T14:30:00"
    }
  ]
}
```

### 필드 설명
| 필드 | 설명 | 계산 방식 |
|------|------|-----------|
| `code` | 종목 코드 | 사용자 입력 |
| `name` | 종목명 | 자동 조회 |
| `quantity` | 보유 수량 | 사용자 입력 |
| `avg_price` | 평균 단가 | 사용자 입력 또는 자동 계산 |
| `total_cost` | 총 매입금액 | `quantity * avg_price` |
| `current_price` | 현재가 | 네이버 API 조회 |
| `current_value` | 평가금액 | `quantity * current_price` |
| `return_amount` | 평가손익 | `current_value - total_cost` |
| `return_pct` | 수익률 | `(return_amount / total_cost) * 100` |

---

## 🔗 연동

### 일일 리포트 연동
```python
# scripts/automation/run_daily_report.py
portfolio = load_portfolio()
holdings = [h['code'] for h in portfolio['holdings']]
portfolio_value = sum(h['current_value'] for h in portfolio['holdings'])

reporter.generate_report(
    current_holdings=holdings,
    portfolio_value=portfolio_value
)
```

### 백테스트 비교
```python
# 실전 성과 vs 백테스트 성과
실전 수익률 = portfolio['total_return_pct']
백테스트 수익률 = backtest_result['total_return']
차이 = 실전 수익률 - 백테스트 수익률
```

---

## 🚀 다음 단계

### 1. 포트폴리오 등록 (오늘)
- UI에서 현재 보유 종목 등록
- 수량 + 평균 단가 입력
- 현재가 업데이트 확인

### 2. 일일 리포트 연동 (내일)
- `run_daily_report.py` 수정
- 실제 보유 종목 표시
- 실제 손익 계산

### 3. 실전 운영 (이번 주)
- 매일 현재가 업데이트
- 일일 리포트 확인
- 매매 신호 따라 실행

---

## 📞 문의

문제가 있거나 개선 아이디어가 있으면 알려주세요!
