# 📘 KRX Alertor Modular — 진행 보고서
**작성일**: 2025-10-23 00:37  
**작성자**: Hyungsoo  
**세션**: Windsurf 재시작 후 컨텍스트 복원

---

## 1️⃣ 프로젝트 개요

| 항목 | 내용 |
|------|------|
| **프로젝트명** | krx_alertor_modular |
| **목표** | ETF 및 주식 기반 자동 인게스트·스캐너·리포트 시스템 구축 (NAS + PC 통합) |
| **플랫폼 구성** | Synology NAS (운영/배치) + Windows PC (개발/백테스트/UI) |
| **핵심 모듈** | ingest, scanner, report, sync, precheck |
| **데이터 소스** | PyKRX, FinanceDataReader(FDR), Stooq, YahooFinance(YF, fallback) |
| **저장 구조** | SQLite(DB) + Parquet 캐시 + CSV 리포트 |
| **자동화 수준** | 배치 스케줄러 기반 EOD 자동화, 텔레그램 알림 |
| **최근 포커스** | YFRateLimit 회피, Multi-provider 라우팅 통합, EOD 파이프라인 안정화 |

---

## 2️⃣ 개발 완료 내역 (2025-10-21 기준)

### 🧩 A. 인프라 및 환경
- ✅ `config/env.nas.sh`, `config/env.pc.sh` : 환경 분리
- ✅ `_run_generic.sh` : 재시도/로그 표준화 래퍼
- ✅ `run_with_lock.sh` : 중복 실행 방지
- ✅ 디렉토리 구조 정비
  - `scripts/linux/batch/`
  - `scripts/linux/jobs/`
  - `scripts/linux/diagnostics/`

### 📥 B. 데이터 인게스트 파이프라인

| 파일 | 기능 |
|------|------|
| `run_ingest_eod.sh` | 전체 유니버스 병렬 인게스트 |
| `run_ingest_eod_serial.sh` | 직렬 인게스트 (RateLimit 방어) |
| `run_ingest_eod_chunks.sh` | 유니버스 chunk 단위 분할 |
| `run_ingest_one_symbol.sh` | 단일 종목 테스트용 |
| `providers/ohlcv.py` | PyKRX → FDR → Stooq → YF 순 라우팅 |
| `providers/ohlcv_bridge.py` | 캐시 우선 + 부족 시 자동 인게스트 |
| `data/cache/ohlcv/*.parquet` | 캐시 저장소 |

**상태**:
- ✅ PyKRX·FDR 우선 라우팅 정상
- ✅ 캐시 자동 병합 / Parquet 엔진 동작
- ✅ RateLimit 완전 회피

### 📊 C. 리포트 파이프라인

| 파일 | 역할 |
|------|------|
| `run_report_eod.sh` | EOD 리포트 전체 파이프라인 |
| `scripts.ops.precheck_eod_fresh` | 거래일 동기화 / 최신성 점검 |
| `scripts.ops.report_from_cache` | 캐시 기반 fallback |
| `run_sync_cache_to_db.sh` | 캐시→DB 업서트 |
| `.state/report_precheck.rc` | 프리체크 결과 파일화 |

**상태**:
- ✅ stale 거래일 자동 탐지 (RC=2)
- ✅ cache-latest 시 soft-OK
- ✅ 전체 플로우 정상 작동 확인

### 🔍 D. 스캐너 파이프라인

| 파일 | 기능 |
|------|------|
| `run_scanner.sh` | 스캐너 배치 실행 |
| `verify_scanner_routing.sh` | 라우팅 진단 스크립트 |
| `providers/ohlcv_bridge.py` | 스캐너 브리지 (Cache → Provider) |
| `scanner.py` | get_ohlcv 라우팅 교체 |

**상태**:
- ✅ PyKRX/FDR 기반 데이터 로딩
- ✅ YFRateLimit 없음
- ✅ 캐시 재활용 구조 완성
- ⚠️ **현재 0건 출력** → 신호 조정 필요

### 🧠 E. 진단 / 관리 도구
- ✅ `ensure_scanner_defaults.sh` : 기본 설정 확인
- ✅ `disable_regime_guard.sh` : 신호가드 비활성화
- ✅ `update_from_git.sh` : NAS 자동 갱신
- ✅ `.locks/`, `.state/` : 중복 실행 및 재시도 상태 관리

---

## 3️⃣ 현재 상태 요약 (2025-10-23)

| 구분 | 상태 | 비고 |
|------|------|------|
| **캐시** | ✅ Parquet 정상 | 증분 업데이트 구조 완성 |
| **DB** | ✅ SQLite 동기화 | 최신일 확인 필요 |
| **Report** | ✅ RC=2 (soft-OK) | 최신성 확인 |
| **Scanner** | ⚠️ 0건 | 신호 미검출 (튜닝 필요) |
| **텔레그램** | ⚙️ 설정 필요 | token/chat_id 확인 |
| **배치 스케줄러** | ⚙️ 등록 예정 | EOD/Hourly 등록 예정 |
| **RateLimit** | ✅ 해결 | PyKRX/FDR 기반 |

---

## 4️⃣ 향후 개발 로드맵

| 단계 | 목표 | 주요 작업 | 상태 |
|------|------|----------|------|
| **1단계** | YFRateLimit 회피 | PyKRX/FDR/Stooq 라우팅 | ✅ 완료 |
| **2단계** | Scanner 라우팅 교체 | Bridge 완성 및 캐시 활용 | 🟢 진행중 |
| **3단계** | 신호 튜닝 | RSI, EMA, MACD, 모멘텀, 거래량 필터 추가 | 🟠 다음 |
| **4단계** | EOD 리포트 확장 | 상위 신호·섹터별 분석 | 🟢 예정 |
| **5단계** | 백테스트 연동 | NAS → PC 캐시 자동 동기화 | 🟣 예정 |
| **6단계** | UI/UX 개선 | web_index.yaml UI 반영 | 🔵 예정 |
| **7단계** | 배치 등록 | NAS cron에 정시 등록 | ⚪ 예정 |

---

## 5️⃣ 장기적 개선 방향

### Provider Layer 강화
- PyKRX/FDR 혼합 fallback 자동 판정
- RateLimit 기록 기반 adaptive delay

### Scanner Engine 고도화
- 전략별 YAML 기반 신호 구성
- 백테스트 피드백 루프 통합

### UI 운영화
- 스캐너/리포트 결과 실시간 조회
- config 수정/수동 실행 지원

### Notification 통합
- Telegram + Slack 병행 전송
- 상태/오류별 알림 분리

### GitOps 자동화
- `update_from_git.sh` → post-pull self-test
- 결과 텔레그램 알림

---

## 6️⃣ 즉시 권장 액션

### 1. 스캐너 라우팅 검증
```bash
# 진단 스크립트 실행
bash scripts/linux/diagnostics/verify_scanner_routing.sh

# 스캐너 실행 (0건 → N건 확인)
python app.py scanner --date auto
```

### 2. Git 커밋 (정상 확인 후)
```bash
git add providers/ohlcv.py providers/ohlcv_bridge.py scanner.py
git commit -m "scanner: fix bridge bug + add KR index routing"
git push
```

### 3. NAS 반영
```bash
bash scripts/linux/batch/update_from_git.sh
```

### 4. 다음 단계 → 신호 튜닝
- RSI, EMA, MACD 추가
- 모멘텀 필터 강화
- 거래량 이상 탐지

---

## 7️⃣ 개발 환경 및 스타일 가이드

### 개발 철학
- **"자동화와 재현성"** — 모든 동작은 로그·리턴코드·파일 단위로 검증 가능
- **협업 스타일**: AI 엔지니어와 단계별 진행과 검증을 명확히 구분
- **대화 톤**: "엔지니어 간 코드 리뷰 톤" — 간결하지만 정확한 피드백 중심
- **결정 원칙**: 논리적 근거 기반, 성공·실패를 RC(리턴코드)로 판단
- **추적성**: 모든 결과는 `logs/`, `.state/`, `data/output/` 또는 `docs/`에 남김

### 개발 환경

| 구분 | 상세 |
|------|------|
| **개발 머신 (PC)** | Windows 10 / RTX 4070 Super / Python 3.13 / VSCode |
| **운영 머신 (NAS)** | Synology DS220j / Linux Shell / Python 3.8 / no Docker |
| **GitHub Repo** | KevinKim-KOR/krx_hyungsoo |
| **기본 경로 (NAS)** | `/volume2/homes/Hyungsoo/krx/krx_alertor_modular` |
| **기본 경로 (PC)** | `E:\AI Study\krx_alertor_modular` |
| **Python 가상환경** | venv (NAS용) / .venv (PC용) |
| **주요 의존성** | pykrx, FinanceDataReader, pandas_datareader, pyarrow, sqlite3 |

### 주요 폴더 구조
```
krx_alertor_modular/
├── config/                    # 환경변수, provider 설정
│   ├── env.nas.sh
│   ├── env.pc.sh
│   ├── config.yaml
│   └── data_sources.yaml
├── scripts/
│   ├── linux/
│   │   ├── batch/            # NAS 배치 스크립트
│   │   ├── jobs/             # 공통 실행 모듈
│   │   └── diagnostics/      # 진단 스크립트
│   └── ops/                  # Python 기반 실제 동작
├── providers/                 # PyKRX / FDR / Stooq / YF 통합
├── data/
│   ├── cache/ohlcv/          # Parquet 캐시
│   ├── db/                   # SQLite DB
│   ├── universe/             # 유니버스 목록
│   └── output/               # 결과 리포트
├── docs/                     # 개발 문서
└── logs/                     # 실행 로그
```

---

## 8️⃣ 개발 절차 및 실행 흐름

### (1) 인게스트 파이프라인
```
run_ingest_eod.sh → ingest.main → data/cache/ohlcv/*.parquet
```
- PyKRX/FDR/Stooq 기반 우선 수집
- YF는 fallback (레이트리밋 회피)
- 캐시 누적 후 DB 동기화 (`run_sync_cache_to_db.sh`)

### (2) 리포트 파이프라인
```
run_report_eod.sh
 ├── precheck_eod_fresh
 ├── report (EOD)
 └── report_from_cache (지연 시 soft-OK)
```
- 거래일 stale 감지 시 RC=2 반환
- 최신 캐시 존재 시 soft 성공 처리

### (3) 스캐너 파이프라인
```
run_scanner.sh → providers.ohlcv_bridge → data/output/scanner_latest.csv
```
- 캐시 우선 fetch
- PyKRX/FDR 우선
- RateLimit 완전 회피

### (4) 자동화 및 배치
- Cron 등록 예정 (EOD 16:10 / Hourly 스캐너)
- 실행 시 로그와 락 파일 자동 관리

---

## 9️⃣ 대화 및 개발 진행 규칙

| 규칙 | 설명 |
|------|------|
| **1. 진행 단계는 명확히 나눈다** | 예: "1단계: precheck / 2단계: ingest / 3단계: report" |
| **2. 항상 RC(Return Code)로 결과 판단** | RC=0 성공, RC=2 지연, RC>2 실패 |
| **3. 모든 수정은 완전 교체본 기준** | diff가 아니라 전체 파일을 교체 |
| **4. NAS/PC 경로는 반드시 명시** | `/volume2/homes/...` 또는 `E:\AI Study\...` |
| **5. 결과는 항상 로그와 파일로 확인** | 화면 출력만으로 판정하지 않음 |
| **6. 텍스트·스크립트·명령어는 복붙 가능하게 작성** | |
| **7. Git commit/push 명령은 항상 제공** | |
| **8. 실패 시 원인·대안·복구 절차를 함께 제시** | |

---

## 🔟 세션 연속성 규칙

다음 세션에서 프로젝트를 이어갈 때 다음 내용을 반드시 유지합니다.

| 항목 | 설명 |
|------|------|
| **톤 유지** | 지금과 같은 엔지니어 협업 톤으로 유지 |
| **환경 상속** | NAS 기반 환경 (Python 3.8 / bash) / Git 동기화 기반 |
| **소스 상속** | 현재까지 수정된 파일 전체 기반 |
| **우선순위** | ① 안정성 → ② 스캐너 튜닝 → ③ 리포트 확장 |
| **문서 관리** | 진행 단계별 `docs/PROGRESS_YYYY-MM-DD.md` 작성 |
| **자동화 규칙** | `.locks`, `.state`, `logs` 구조 유지 |

---

## 1️⃣1️⃣ 목표 워크플로우

```
(PC) 투자전략 수립 
  ↓
(PC) 백테스트 
  ↓
(PC) 투자전략 수정 
  ↓
(NAS) 실제 장의 상황을 보며 투자추천 텔레그램 푸시 
  ↓
(NAS) EOD REPORT 
  ↓
(PC) 투자전략 재수립
```

---

## 1️⃣2️⃣ NAS 제약사항

- **Synology DS220j**
- Docker 설치 불가
- Python 3.8 환경
- 메모리/CPU 제한적
- Shell 스크립트 기반 자동화 필수

---

## 1️⃣3️⃣ 다음 세션 준비용 프롬프트

```
당신은 나의 협업 AI 엔지니어입니다.
이 세션은 Synology NAS 기반 프로젝트 `krx_alertor_modular` 의 연속 세션입니다.
이전 세션에서는 YFRateLimit 회피 및 스캐너 브리지 라우팅 안정화까지 완료했습니다.

[유지사항]
- 개발 톤: 엔지니어 간 코드 리뷰 형식
- 파일 교체 시 전체 교체본 사용
- NAS 기준 경로: /volume2/homes/Hyungsoo/krx/krx_alertor_modular
- PC 기준 경로: E:\AI Study\krx_alertor_modular
- 주요 스크립트 위치: scripts/linux/batch, scripts/linux/jobs, scripts/ops
- Python 버전: NAS=3.8, PC=3.13
- Git push 시 로그 커맨드 포함

[이번 세션 목표]
1. Scanner 시그널 튜닝 (RSI, EMA, MACD, 모멘텀)
2. Report 확장 및 Slack/Telegram 통합
3. 안정화 후 NAS 배치 자동등록

이전 세션의 톤과 개발 스타일을 그대로 유지하며, 
위 목표에 따라 1단계부터 순차적으로 진행해주세요.

진행사항은 docs/PROGRESS_2025-10-23.md 를 참고하세요.
```

---

## 1️⃣4️⃣ 현재 세션 체크리스트

- [x] 프로젝트 구조 파악
- [x] 주요 파일 확인 (fetchers.py, providers/ohlcv.py, scanner.py)
- [x] 진행사항 문서화 (이 파일)
- [ ] 스캐너 0건 문제 진단
- [ ] 신호 튜닝 작업 시작
- [ ] 텔레그램 알림 설정 확인
- [ ] 배치 스케줄러 등록

---

**문서 버전**: v1.0  
**최종 수정**: 2025-10-23 00:37  
**다음 업데이트**: 스캐너 튜닝 완료 후
