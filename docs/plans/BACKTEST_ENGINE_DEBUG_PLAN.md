# 백테스트 엔진 디버깅 계획

**작성일**: 2025-12-08  
**상태**: ✅ 완료 (2025-12-08)  
**원인**: ChatGPT 분석 결과 백테스트 지표가 수학적으로 불가능한 상태

---

## 1. 발견된 문제

### 1.1 ChatGPT 분석 결과

| 이상 징후 | 상세 |
|----------|------|
| 변동성 0%인데 Sharpe 4.95 | 0으로 나눔 → 정의 불가 |
| 총 수익률 16.73%인데 CAGR 87% | 3개월 연환산 (무의미) |
| 매도 0회 | 매도 로직 미작동 |
| 손익비 0 | P/L 계산 누락 |
| 거래비용 0원 | 비용 모델 미적용 |
| 평균 수익/손실 0원 | 거래 손익 계산 누락 |

### 1.2 결론

> "이 백테스트는 지표가 완전히 무너져 있어서 전략의 실제 성능을 평가할 수 없습니다."

---

## 2. 디버깅 체크리스트

### 2.1 변동성 계산 (최우선) ✅ 해결

- [x] `core/engine/backtest.py`에서 변동성 계산 로직 확인 → 정상
- [x] 일간 수익률 계산 정상 여부 → 정상
- [x] 문제 원인: **거래가 없어서 NAV 변동 없음** → 모멘텀 리밸런싱 추가로 해결

### 2.2 매도 로직 ✅ 해결

- [x] 문제 원인: **고정 종목 + 동일 비중** 전략이라 종목 교체 없음
- [x] 해결: `runner.py`에 **모멘텀 스코어 기반 Top N 재선정** 로직 추가
- [x] 5영업일마다 리밸런싱 → 종목 교체 시 매도 발생

### 2.3 P/L 계산 ✅ 해결

- [x] 개별 거래 손익 계산 로직 → 정상 (매도 발생 후 계산됨)
- [x] 평균 수익/손실 계산 → Avg Win: 15,593원, Avg Loss: -30,800원
- [x] 손익비 계산 → Trade Win Rate: 20%

### 2.4 거래비용 ✅ 정상

- [x] 수수료 적용 확인 → 2,114원
- [x] 슬리피지 적용 확인 → 14,086원
- [x] ETF 세금 적용 확인 → 0원 (면세)

### 2.5 레짐 연동 ✅ 정상

- [x] 레짐 신호 → 포지션 크기 반영
- [x] Bull/Neutral/Bear 별 노출 비율

---

## 3. 디버깅 순서

```
1단계: 변동성 계산 수정
  ↓
2단계: 매도 로직 확인
  ↓
3단계: P/L 계산 복구
  ↓
4단계: 거래비용 적용 확인
  ↓
5단계: 전체 백테스트 재실행 및 검증
```

---

## 4. 검증 기준

정상적인 백테스트 결과 예시:

| 지표 | 정상 범위 |
|------|----------|
| CAGR | 10~30% (1년 이상 기간) |
| Sharpe | 0.5~2.0 |
| MDD | 5~20% |
| 변동성 | 10~25% |
| 손익비 | 1.0~3.0 |
| 거래비용 | 0이 아닌 값 |

---

## 5. 관련 파일

- `core/engine/backtest.py` - 백테스트 엔진
- `app/services/backtest_service.py` - 백테스트 서비스
- `config/backtest.yaml` - 비용 설정

---

## 6. 다음 단계

1. **이 문서 기반으로 디버깅 진행**
2. 디버깅 완료 후 **정상 백테스트 결과 확인**
3. 그 후 **Phase 4 (새 변수 추가)** 진행
