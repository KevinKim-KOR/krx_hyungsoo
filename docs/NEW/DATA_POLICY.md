# DATA_POLICY — 데이터 정책 및 품질 관리 (v2)

## 1. 목적
데이터는 투자모델의 재현성과 정확성을 좌우한다. 본 문서는 **데이터 소스**, **보정 규칙**, **휴장일 처리**, **예외·로그 정책**을 정의한다.

---

## 2. 데이터 소스 정의
| 구분 | 소스 | 용도 | 우선순위 | 갱신 주기 |
|------|------|------|-----------|-----------|
| 한국 주가 | pykrx → naver | EOD 및 실시간 시세 | 1 | 일일 |
| 해외 주가 | yfinance | EOD 및 지연 시세 | 2 | 일일 |
| 벤치마크 | KOSPI200, S&P500 등 | 전략 비교 | 3 | 주간 |
| 무위험수익률 | 국채 3개월 | Sharpe 계산 | 4 | 월간 |
| 섹터 분류 | KRX 업종코드 | 분석용 | 5 | 필요시 |

> 실제 사용 소스는 `configs/data_sources.yaml`에 정의하고 관리한다.

---

## 3. 데이터 저장 구조
```
data/
  cache/
    krx/*.pkl
    naver/*.pkl
    yf/*.pkl
  logs/
    ingest_YYYY-MM-DD.log
```
- 각 종목 데이터는 `.pkl` 캐시로 저장.
- 새로 인입 시, 기존 캐시 대비 증분만 추가 저장.
- dataset_id(YYYYMMDD-HHMM)를 부여해 버전 관리.

---

## 4. 보정 및 처리 규칙
| 항목 | 설명 | 규칙 |
|------|------|------|
| **가격보정** | 액면분할/배당 조정 | Adjusted Close 기준 |
| **거래량보정** | 병합, 유상증자 반영 | Split Ratio 적용 |
| **시간대** | 한국 표준시 | Asia/Seoul 고정 |
| **통화기준** | 원화(KRW) | 필요 시 USD→KRW 변환 |
| **결측치** | 비거래일·데이터 누락 | forward fill 사용 |
| **이상치** | 급등락/비정상 값 | IQR/Z-score 필터 적용 |

---

## 5. 휴장일 처리 원칙
1. 휴장일은 다음 거래일로 간주한다.
2. 휴장일에는 새로운 시세 조회 없이 캐시 데이터 사용.
3. 휴장일 이후 첫 거래일 데이터를 기준으로 추천 생성.
4. 캐시 미존재 시 직전 거래일 데이터를 이용.
5. 휴장일의 일간 수익률은 0%로 표기.

```python
# 예시: 휴장일 자동 판별 로직
if not is_trading_day(today):
    ref_date = get_prev_trading_day(today)
    use_cached_prices(ref_date)
```

---

## 6. 데이터 검증 절차
1. **스키마 검사**: 컬럼명, 타입, 단위 점검.
2. **결측 검사**: null 비율 < 0.1%, 초과 시 WARNING.
3. **연속성 검사**: 거래일 캘린더 일치 여부.
4. **이상치 검사**: Z-score > 6 제거 및 로그 기록.
5. **버전 검증**: dataset_id 발급 후 검증 리포트 생성.

검증 리포트 예시:
```
reports/data_validation/2025-10-24_krx_summary.md
```

---

## 7. 로그 및 예외 처리 정책
| 상황 | 조치 | 로그 수준 |
|------|------|-------------|
| 데이터 누락 | 캐시 사용, 경고 출력 | WARNING |
| 비정상 데이터 (음수, NaN) | 해당 종목 제외 | ERROR |
| 거래 정지/폐지 | 계산 제외, 사유 기록 | INFO |
| 데이터 부족 | 해당 종목 제외 | INFO |
| API 실패 | 재시도 3회 후 중단 | ERROR |

모든 오류 로그는 `send_verbose_log_to_slack()`을 통해 Slack으로 전달된다.

---

## 8. 재현성 원칙
- 동일 dataset_id로 항상 동일 결과 산출.
- 데이터 검증 완료 후 commit-log 남김.
- 캐시 파일 해시(SHA256)로 무결성 검증.

---

## 9. 품질 기준 (SLA)
| 항목 | 기준 |
|------|------|
| 인입 완료 시간 | < 5분 |
| 결측률 | < 0.1% |
| 이상치 비율 | < 0.05% |
| 검증 리포트 생성 | 매일 1회 이상 |

---

## 10. 향후 개선
- 거래소 캘린더 API 기반 휴장일 자동 감지
- Polars 기반 병렬 검증(비차단 방식)
- 데이터 무결성 지표 시각화 리포트

> v2에서는 `pykrx/네이버` 데이터 통합, 휴장일 캐시 처리, 예외 로깅 정책을 강화하였다.

