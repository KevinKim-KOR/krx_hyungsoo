<!-- web/templates/bt_history.html -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <title>백테스트 비교 (최근 2개)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; }
    h1 { margin-bottom: 12px; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 16px; margin: 12px 0; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 6px 8px; border-bottom: 1px solid #eee; text-align: right; }
    th:first-child, td:first-child { text-align: left; }
    .muted { color: #777; }
    .pos { color: #0a7; }
    .neg { color: #d33; }
    .tag { font-size: 12px; color: #555; background: #f3f3f3; border-radius: 6px; padding: 2px 6px; display: inline-block; }
    .k { color: #555; }
    .toolbar { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .btn { display:inline-block; padding:6px 10px; border:1px solid #ccc; border-radius:8px; text-decoration:none; color:#333; background:#fafafa; }
    .btn:hover { background:#f2f2f2; }
    select, input[type="number"] { padding:4px 8px; border:1px solid #ccc; border-radius:8px; }
    label { font-size: 14px; color:#444; margin-right: 6px; }
    canvas { width:100%; max-width:1100px; height:360px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="toolbar">
    <h1 style="margin:0">백테스트 비교</h1>
    {% if has_data %}
      <form id="ctl" method="get" action="/bt/history" class="toolbar">
        <label>A</label>
        <select name="pkg_a" id="pkg_a">
          {% for opt in options %}
            <option value="{{ opt.key }}" {{ 'selected' if opt.key==sel_a else '' }}>
              {{ opt.label }}
            </option>
          {% endfor %}
        </select>

        <label>B</label>
        <select name="pkg_b" id="pkg_b">
          {% for opt in options %}
            <option value="{{ opt.key }}" {{ 'selected' if opt.key==sel_b else '' }}>
              {{ opt.label }}
            </option>
          {% endfor %}
        </select>

        <label>최근 거래일</label>
        <input type="number" name="ndays" min="30" max="2000" value="{{ ndays }}" />
        <button class="btn" type="submit">적용</button>

        <a class="btn" id="csvBtn" href="#">CSV 내보내기</a>
      </form>
    {% endif %}
  </div>

  {% if not has_data %}
    <div class="card">{{ msg }}</div>
  {% else %}

    <div class="card grid">
      <div>
        <h3>패키지 A</h3>
        <div class="muted">{{ pkg_a.final_dir }}</div>
        <div class="tag">commit: {{ pkg_a.manifest.commit[:10] }}</div>
      </div>
      <div>
        <h3>패키지 B</h3>
        <div class="muted">{{ pkg_b.final_dir }}</div>
        <div class="tag">commit: {{ pkg_b.manifest.commit[:10] }}</div>
      </div>
    </div>

    <div class="card grid">
      <div>
        <h3>설정 & 요약 (A)</h3>
        <table>
          <tbody>
            <tr><td class="k">기간</td><td>{{ a_info.start }} → {{ a_info.end }}</td></tr>
            <tr><td class="k">모드</td><td>{{ a_info.mode }}</td></tr>
            <tr><td class="k">Watchlist</td><td>{{ a_info.wl }}</td></tr>
            <tr><td class="k">Top N</td><td>{{ a_info.top }}</td></tr>
            <tr><td class="k">행 수</td><td>{{ a_info.rows }}</td></tr>
            {% if a_info.notes %}<tr><td class="k">비고</td><td>{{ a_info.notes }}</td></tr>{% endif %}
          </tbody>
        </table>
      </div>
      <div>
        <h3>설정 & 요약 (B)</h3>
        <table>
          <tbody>
            <tr><td class="k">기간</td><td>{{ b_info.start }} → {{ b_info.end }}</td></tr>
            <tr><td class="k">모드</td><td>{{ b_info.mode }}</td></tr>
            <tr><td class="k">Watchlist</td><td>{{ b_info.wl }}</td></tr>
            <tr><td class="k">Top N</td><td>{{ b_info.top }}</td></tr>
            <tr><td class="k">행 수</td><td>{{ b_info.rows }}</td></tr>
            {% if b_info.notes %}<tr><td class="k">비고</td><td>{{ b_info.notes }}</td></tr>{% endif %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="card grid">
      <div>
        <h3>종합지표 (공통구간)</h3>
        <table>
          <thead><tr><th>지표</th><th>A</th><th>B</th></tr></thead>
          <tbody>
            <tr><td>최종 NAV</td><td>{{ '%.4f' % a_end if a_end is not none else '-' }}</td><td>{{ '%.4f' % b_end if b_end is not none else '-' }}</td></tr>
            <tr><td>최근 30일 수익</td>
              <td class="{{ 'pos' if a_30d and a_30d>0 else ('neg' if a_30d and a_30d<0 else '') }}">{{ '%.2f%%' % (a_30d*100) if a_30d is not none else '-' }}</td>
              <td class="{{ 'pos' if b_30d and b_30d>0 else ('neg' if b_30d and b_30d<0 else '') }}">{{ '%.2f%%' % (b_30d*100) if b_30d is not none else '-' }}</td>
            </tr>
            <tr><td>최대 낙폭(MDD)</td>
              <td class="{{ 'neg' if a_mdd and a_mdd<0 else '' }}">{{ '%.2f%%' % (a_mdd*100) if a_mdd is not none else '-' }}</td>
              <td class="{{ 'neg' if b_mdd and b_mdd<0 else '' }}">{{ '%.2f%%' % (b_mdd*100) if b_mdd is not none else '-' }}</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div>
        <h3>설명</h3>
        <ul>
          <li>드롭다운에서 <b>임의의 두 패키지</b>를 선택해 비교할 수 있습니다.</li>
          <li><b>최근 거래일 수</b>를 조절해 차트/표의 표시 구간을 바꿀 수 있습니다.</li>
          <li>NAV는 <code>equity1.csv</code> 기준으로 비교합니다.</li>
        </ul>
      </div>
    </div>

    <!-- NAV 라인 차트 -->
    <div class="card">
      <h3>NAV 추이 (공통구간, 최근 {{ ndays }}거래일)</h3>
      <canvas id="navChart"></canvas>
    </div>

    <div class="card">
      <h3>최근 50개 일자 비교 (공통구간)</h3>
      <table>
        <thead>
          <tr><th>date</th><th>NAV(A)</th><th>NAV(B)</th><th>ret(A)</th><th>ret(B)</th></tr>
        </thead>
        <tbody>
          {% for d,na,nb,ra,rb in rows %}
            <tr>
              <td>{{ d }}</td>
              <td>{{ '%.4f' % na }}</td>
              <td>{{ '%.4f' % nb }}</td>
              <td class="{{ 'pos' if ra>0 else ('neg' if ra<0 else '') }}">{{ '%.3f' % ra }}</td>
              <td class="{{ 'pos' if rb>0 else ('neg' if rb<0 else '') }}">{{ '%.3f' % rb }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <script>
      (function(){
        const labels = {{ labels|tojson }};
        const a = {{ series_a|tojson }};
        const b = {{ series_b|tojson }};
        const ctx = document.getElementById('navChart').getContext('2d');
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [
              {label: 'A NAV', data: a, fill: false, borderWidth: 2, tension: 0.2},
              {label: 'B NAV', data: b, fill: false, borderWidth: 2, tension: 0.2}
            ]
          },
          options: {
            responsive: true,
            interaction: { mode: 'index', intersect: false },
            plugins: { legend: { position: 'top' } },
            scales: { x: { ticks: { maxRotation: 0, autoSkip: true } }, y: { beginAtZero: false } }
          }
        });

        // CSV 버튼: 현재 선택값 그대로 전달
        const form = document.getElementById('ctl');
        const csvBtn = document.getElementById('csvBtn');
        if (form && csvBtn) {
          function updateCsvHref(){
            const sp = new URLSearchParams(new FormData(form));
            csvBtn.href = '/bt/history.csv?' + sp.toString();
          }
          updateCsvHref();
          form.addEventListener('change', updateCsvHref);
          form.addEventListener('input', updateCsvHref);
        }
      })();
    </script>

  {% endif %}
</body>
</html>
